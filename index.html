<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Question Bank</title>
    <style>
        /* --- START OF styles.css --- */
        :root {
            /* Light Theme Variables */
            --body-bg: #f8fafc;            --container-bg: #ffffff;
            --text-color: #1e293b;         --text-muted: #64748b;
            --text-heading: #0f172a;       --border-color: #e2e8f0;
            --border-color-hover: #cbd5e1; --accent-color: #2563eb;
            --accent-color-dark: #1d4ed8;  --accent-color-light: #dbeafe;
            --button-bg: #ffffff;          --button-border: #e0e0e0;
            --button-text: #334155;        --button-hover-bg: #f1f5f9;
            --button-active-bg: #0f172a;   --button-active-text: #ffffff;
            --button-secondary-bg: #64748b;--button-secondary-hover-bg: #475569;
            --button-disabled-bg: #94a3b8; --input-bg: #ffffff;
            --input-border: #cbd5e1;       --feedback-bg: #f1f5f9;
            --feedback-border: #e2e8f0;    --correct-bg: #dcfce7;
            --correct-border: #16a34a;     --correct-text: #065f46;
            --incorrect-bg: #fee2e2;       --incorrect-border: #ef4444;
            --incorrect-text: #b91c1c;     --partial-bg: #fef9c3;
            --partial-border: #f59e0b;     --partial-text: #854d0e;
            --shadow-color: rgba(0,0,0,0.05); --matched-item-bg: #e5e7eb;
            --matched-item-border: #9ca3af; --modal-overlay-bg: rgba(15, 23, 42, 0.6);
            --modal-bg: #ffffff;           --lesson-stat-text: #475569;
            --lesson-perfect-bg: #e0fadf;  --lesson-perfect-border: #54c780;
            --lesson-perfect-text: #065f46;--lesson-imperfect-bg: #ffe9e9;
            --lesson-imperfect-border: #f79494; --lesson-imperfect-text: #b91c1c;
        }

        body.dark-theme {
            /* Dark Theme Overrides */
            --body-bg: #0f172a;           --container-bg: #1e293b;
            --text-color: #cbd5e1;        --text-muted: #94a3b8;
            --text-heading: #f1f5f9;      --border-color: #334155;
            --border-color-hover: #475569;--accent-color: #3b82f6;
            --accent-color-dark: #2563eb; --accent-color-light: #1e3a8a;
            --button-bg: #334155;         --button-border: #475569;
            --button-text: #e2e8f0;       --button-hover-bg: #475569;
            --button-active-bg: #f1f5f9;  --button-active-text: #0f172a;
            --button-secondary-bg: #475569;--button-secondary-hover-bg: #52525b;
            --button-disabled-bg: #334155;--input-bg: #0f172a;
            --input-border: #475569;      --feedback-bg: #1e293b;
            --feedback-border: #334155;   --correct-bg: #064e3b;
            --correct-border: #10b981;    --correct-text: #a7f3d0;
            --incorrect-bg: #7f1d1d;      --incorrect-border: #f87171;
            --incorrect-text: #fecaca;    --partial-bg: #713f12;
            --partial-border: #fbbf24;    --partial-text: #fef08a;
            --shadow-color: rgba(0,0,0,0.2); --matched-item-bg: #475569;
            --matched-item-border: #64748b; --modal-overlay-bg: rgba(0, 0, 0, 0.7);
            --modal-bg: #1e293b;          --lesson-stat-text: #94a3b8;
            --lesson-perfect-bg: #064e3b; --lesson-perfect-border: #10b981;
            --lesson-perfect-text: #a7f3d0;--lesson-imperfect-bg: #7f1d1d;
            --lesson-imperfect-border: #f87171; --lesson-imperfect-text: #fecaca;
        }


        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0; padding: 0; background-color: var(--body-bg);
            color: var(--text-color); transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- RTL Layout --- */
        .rtl-layout { direction: rtl; }
        .rtl-layout * { direction: rtl; } /* Inherit by default */
        .rtl-layout [dir="ltr"] * { direction: ltr; } /* Allow overriding for specific LTR content */

        .rtl-layout .header { text-align: right; }
        .rtl-layout .nav-btn { flex-direction: row-reverse; }
        .rtl-layout .nav-btn span:first-child { margin-left: 0; margin-right: 6px; }
        .rtl-layout .section-content {
            text-align: right; border-left-width: 1px; border-left-color: var(--button-border);
            border-right-width: 4px; border-right-color: transparent;
        }
        .rtl-layout .section-content.lesson-complete-perfect { border-right-color: var(--lesson-perfect-border); border-left-color: var(--lesson-perfect-border); }
        .rtl-layout .section-content.lesson-complete-imperfect { border-right-color: var(--lesson-imperfect-border); border-left-color: var(--lesson-imperfect-border); }
        .rtl-layout .lesson-title-text { margin-right: 0; margin-left: 10px; }
        .rtl-layout .lesson-stats-display { margin-left: 10px; margin-right: auto; }
        .rtl-layout .lesson-q-count { margin-left: 0; margin-right: 10px; }
        .rtl-layout #quiz-header { text-align: right; }
        .rtl-layout #quiz-header #back-to-topics-btn { flex-direction: row-reverse; }
        #back-to-topics-btn > span:first-child, /* LTR Arrow */
        .rtl-layout #back-to-topics-btn > span:first-child { /* RTL Arrow */
            display: inline-block; margin: 0 4px;
        }
        .rtl-layout .question-progress { text-align: left; }
        .rtl-layout .question-text { text-align: right; }
        .rtl-layout .question-text strong { margin-right: 0; margin-left: 5px; }
        .rtl-layout .option-label { flex-direction: row-reverse; }
        .rtl-layout .option-input { margin-right: 0; margin-left: 15px; }
        .rtl-layout .matching-container { flex-direction: row-reverse; } /* Flip columns */
        .rtl-layout .matching-column h4 { text-align: right; }
        .rtl-layout .ordering-item { flex-direction: row-reverse; }
        .rtl-layout .ordering-select { margin-right: 0; margin-left: 15px; }
        .rtl-layout #feedback-container { text-align: right; }
        .rtl-layout .incorrect-feedback span { text-align: right; }
        .rtl-layout #quiz-buttons-container { justify-content: flex-start; }
        .rtl-layout .results-actions .back-to-topics-btn { margin-left: 0; margin-right: auto; }
        .rtl-layout .review-actions .back-to-topics-btn { margin-left: 0; margin-right: auto; }
        .rtl-layout .results-details { text-align: right; }
        .rtl-layout .results-details p { flex-direction: row-reverse; }
        .rtl-layout .results-details p strong { min-width: auto; margin-right: 0; margin-left: 10px; }
        .rtl-layout .review-question-header { flex-direction: row-reverse; }
        .rtl-layout .review-question-text { text-align: right; }
        .rtl-layout .review-mc-answer p, .rtl-layout .review-matching-answer p, .rtl-layout .review-ordering-answer p { text-align: right; }
        .rtl-layout .review-mc-answer p strong, .rtl-layout .review-matching-answer p strong, .rtl-layout .review-ordering-answer p strong { margin-right: 0; margin-left: 5px; }
        .rtl-layout .review-matching-grid { flex-direction: row-reverse; }
        .rtl-layout .review-matching-column div { text-align: right; }
        .rtl-layout .review-ordering-list-item { flex-direction: row-reverse; }
        .rtl-layout .review-order-number { margin-right: 0; margin-left: 8px; }
        .rtl-layout #settings-modal * { direction: rtl; }
        .rtl-layout .modal-header { flex-direction: row-reverse; }
        .rtl-layout .theme-options label { flex-direction: row-reverse; }
        .rtl-layout .theme-options input[type="radio"] { margin-right: 0; margin-left: 10px;}
        .rtl-layout .modal-footer { text-align: left; }
        .rtl-layout .question-review { border-left-width: 1px; border-left-color: var(--border-color); border-right-width: 5px; border-right-color: transparent; }
        .rtl-layout .question-review.correct { border-right-color: var(--correct-border); }
        .rtl-layout .question-review.incorrect { border-right-color: var(--incorrect-border); }
        .rtl-layout .question-review.partial { border-right-color: var(--partial-border); }
        /* Ensure icons in buttons display correctly */
        .rtl-layout .btn > span:first-child { margin-left: 0; margin-right: 6px; }

        /* Welcome View */
        #welcome-view { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; background-color: var(--body-bg); color: var(--text-color); padding: 40px 20px; }
        #welcome-view h1 { font-size: 28px; color: var(--text-heading); margin-bottom: 15px; }
        #welcome-view p { font-size: 16px; color: var(--text-muted); max-width: 600px; line-height: 1.6; margin-bottom: 25px; }
        #welcome-view .info-section { margin-bottom: 20px; font-size: 14px; }
        #welcome-view .info-section strong { display: block; margin-bottom: 5px; color: var(--text-heading); }
        #welcome-view .get-started-btn { margin-top: 30px; }

        /* Main Container */
        .container { max-width: 1200px; margin: 20px auto; background-color: var(--container-bg); padding: 20px 30px; border-radius: 12px; box-shadow: 0 2px 10px var(--shadow-color); border: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease, opacity 0.5s ease; opacity: 1; }
        .container.initially-hidden { opacity: 0; pointer-events: none; }

        .header { display: flex; justify-content: space-between; align-items: center; text-align: left; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .header h1 { font-size: 24px; margin: 0; color: var(--text-heading); }
        #settings-btn { background: none; border: 1px solid var(--button-border); color: var(--text-muted); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 20px; line-height: 1; transition: all 0.2s ease; }
        #settings-btn:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); color: var(--text-color); }

        /* Nav Section */
        .nav-section { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; transition: opacity 0.3s ease, max-height 0.3s ease, visibility 0.3s ease, margin 0.3s ease, padding 0.3s ease; overflow: hidden; max-height: 500px; opacity: 1; visibility: visible; }
        .nav-section.hidden { max-height: 0; opacity: 0; margin-bottom: 0; padding: 0; border: none; visibility: hidden; }
        .subjects { display: flex; flex-wrap: wrap; gap: 10px; }
        .secondary-nav { display: flex; gap: 10px; align-items: center; }
        .nav-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px; background-color: var(--button-bg); border: 1px solid var(--button-border); transition: all 0.2s ease; color: var(--button-text); }
        .nav-btn:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); }
        .nav-btn.active { background-color: var(--button-active-bg); color: var(--button-active-text); border-color: var(--button-active-bg); }

        /* --- CSS FIX: Corrected rule for active nav button icon color --- */
        body.dark-theme .nav-btn.active span {
            filter: none;
        }
        body:not(.dark-theme) .nav-btn.active span {
            filter: brightness(0) invert(1);
        }
        /* --- End CSS Fix --- */

        .semester-toggle { display: flex; gap: 5px; background-color: var(--feedback-bg); padding: 4px; border-radius: 6px; border: 1px solid var(--button-border); }
        .semester-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; background: none; color: var(--text-muted); transition: all 0.2s ease; }
        .semester-btn.active { background-color: var(--container-bg); color: var(--text-heading); box-shadow: 0 1px 3px var(--shadow-color); }

        /* Topic List */
        #content {}
        .semester-title-container { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .unit-title { font-size: 20px; font-weight: 600; color: var(--text-heading); margin: 0; }
        .section { background-color: var(--container-bg); border-radius: 12px; padding: 20px 25px; box-shadow: 0 1px 3px var(--shadow-color); border: 1px solid var(--border-color); margin-bottom: 20px; }
        .semester-content > .section:last-of-type { margin-bottom: 0; }
        .section-title { font-size: 17px; font-weight: 600; margin-bottom: 15px; color: var(--text-heading); }
        .section-content { padding: 12px 15px; background-color: var(--button-bg); border-radius: 8px; border: 1px solid var(--button-border); margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; color: var(--button-text); display: flex; justify-content: space-between; align-items: center; text-align: left; position: relative; overflow: hidden; border-left-width: 4px; border-left-color: transparent; }
        .section-content:last-child { margin-bottom: 0; }
        .section-content:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); transform: translateY(-1px); }
        .section-content.lesson-complete-perfect { background-color: var(--lesson-perfect-bg); border-color: var(--lesson-perfect-border); border-left-color: var(--lesson-perfect-border); }
        .section-content.lesson-complete-perfect span, .section-content.lesson-complete-perfect .lesson-stats-display { color: var(--lesson-perfect-text); font-weight: 500; }
        .section-content.lesson-complete-imperfect { background-color: var(--lesson-imperfect-bg); border-color: var(--lesson-imperfect-border); border-left-color: var(--lesson-imperfect-border); }
        .section-content.lesson-complete-imperfect span, .section-content.lesson-complete-imperfect .lesson-stats-display { color: var(--lesson-imperfect-text); font-weight: 500; }
        .lesson-title-text { flex-grow: 1; margin-right: 10px; }
        .lesson-stats-display { font-size: 0.8em; color: var(--lesson-stat-text); font-weight: 500; white-space: nowrap; flex-shrink: 0; margin-left: auto; padding: 0 10px; }
        .lesson-q-count { font-size: 0.8em; color: var(--lesson-stat-text); font-weight: 400; white-space: nowrap; flex-shrink: 0; }
        .section-content.lesson-complete-perfect .lesson-q-count, .section-content.lesson-complete-imperfect .lesson-q-count { color: inherit; opacity: 0.8; }
        .semester-content { display: none; }
        .semester-content.active { display: block; }

        /* Quiz View */
        #quiz-view { padding: 20px 0; }
        #quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        #quiz-title { font-size: 20px; font-weight: 600; color: var(--text-heading); }
        #quiz-container { margin-bottom: 20px; }
        .question-type-wrapper { padding: 25px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--container-bg); margin-bottom: 20px; box-shadow: 0 1px 2px var(--shadow-color); }
        .question-progress { font-size: 14px; color: var(--text-muted); margin-bottom: 15px; text-align: right; }
        .question-text { font-size: 18px; margin-bottom: 25px; line-height: 1.6; color: var(--text-color); }
        .question-text strong { font-weight: 600; margin-right: 5px; }

        /* MC */
        .options-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 0; }
        .option-label { display: flex; align-items: center; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; background-color: var(--input-bg); }
        .option-label:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); }
        .option-label input:checked + .option-text { font-weight: 500; color: var(--accent-color); }
        .option-label input:checked { accent-color: var(--accent-color); }
        .option-input { margin-right: 15px; flex-shrink: 0; }
        .option-text { flex-grow: 1; font-size: 16px; color: var(--text-color); }

        /* Matching */
        .matching-instructions { font-size: 15px; color: var(--text-muted); margin-bottom: 20px; }
        .matching-container { position: relative; display: flex; justify-content: space-between; gap: 5%; margin-bottom: 0; }
        .matching-column { flex-basis: 47%; display: flex; flex-direction: column; gap: 10px; }
        .matching-column h4 { margin: 0 0 10px 0; font-size: 15px; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .matching-item { padding: 10px 15px; border: 1px solid var(--input-border); background-color: var(--input-bg); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; display: flex; align-items: center; min-height: 30px; color: var(--text-color); }
        .matching-item:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); }
        .matching-item.selected { background-color: var(--accent-color-light); border-color: var(--accent-color); font-weight: 500; }
        .matching-item.matched { background-color: var(--matched-item-bg); border-color: var(--matched-item-border); cursor: pointer; opacity: 1.0; }
        #matching-arrow-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: visible; z-index: 1; }
        #matching-arrow-svg line { stroke: var(--accent-color); stroke-width: 2; transition: stroke 0.3s ease, opacity 0.3s ease; marker-end: url(#arrowhead); } /* Added stroke transition */
        #matching-arrow-svg #arrowhead polygon { fill: var(--accent-color); transition: fill 0.3s ease; }

        /* Ordering */
        .ordering-instructions { font-size: 15px; color: var(--text-muted); margin-bottom: 20px; }
        .ordering-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 0; }
        .ordering-item { display: flex; align-items: center; padding: 10px 15px; border: 1px solid var(--border-color); background-color: var(--input-bg); border-radius: 6px; }
        .ordering-select { margin-right: 15px; padding: 5px 8px; border-radius: 4px; border: 1px solid var(--input-border); font-size: 14px; min-width: 60px; background-color: var(--input-bg); color: var(--text-color); }
        .ordering-text { flex-grow: 1; font-size: 16px; color: var(--text-color); }

        /* Feedback & Buttons */
        #feedback-container { padding: 15px; margin-top: 20px; border-radius: 6px; background-color: var(--feedback-bg); border: 1px solid var(--feedback-border); }
        #feedback-container.hidden { display: none; }
        .correct-feedback { color: var(--correct-text); font-weight: 600; font-size: 16px; }
        .incorrect-feedback { color: var(--incorrect-text); font-weight: 600; font-size: 16px; }
        .incorrect-feedback span { display: block; font-weight: 500; margin-top: 8px; font-size: 15px; color: var(--text-muted); line-height: 1.5; }
        .partial-feedback { color: var(--partial-text); font-weight: 600; font-size: 16px; }
        .correct-option { background-color: var(--correct-bg) !important; border-color: var(--correct-border) !important; }
        .correct-option .option-text { color: var(--correct-text) !important; }
        .incorrect-option { background-color: var(--incorrect-bg) !important; border-color: var(--incorrect-border) !important; }
        .incorrect-option .option-text { color: var(--incorrect-text) !important; }

        /* Button container */
        #quiz-buttons-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end; margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .results-actions, .review-actions { justify-content: space-between; width: 100%; }
        .results-actions { flex-wrap: wrap; justify-content: center; gap: 15px; }
        .results-actions .back-to-topics-btn { margin-left: auto; }
        .review-actions .back-to-topics-btn { margin-left: auto; }
        @media (max-width: 550px) { .results-actions, .review-actions { justify-content: center; } .results-actions .back-to-topics-btn, .review-actions .back-to-topics-btn { margin-left: 0; } }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s ease; line-height: 1.5; background-color: var(--button-bg); color: var(--button-text); border: 1px solid var(--button-border); display: inline-flex; align-items: center; gap: 6px; }
        .btn:hover:not(:disabled) { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); transform: translateY(-1px); }
        .submit-btn { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .submit-btn:hover:not(:disabled) { background-color: var(--accent-color-dark); border-color: var(--accent-color-dark); }
        .submit-btn:disabled { background-color: var(--button-disabled-bg); border-color: var(--button-disabled-bg); color: var(--text-muted); cursor: not-allowed; transform: none; }
        .next-btn { background-color: var(--correct-border); color: var(--correct-text); border-color: var(--correct-border); } body.dark-theme .next-btn { color: white; } .next-btn:hover { filter: brightness(1.1); }
        .review-btn { background-color: var(--correct-border); color: var(--correct-text); border-color: var(--correct-border); } body.dark-theme .review-btn { color: white; } .review-btn:hover { filter: brightness(1.1); }
        .redo-btn { background-color: #f97316; color: white; border-color: #f97316; } .redo-btn:hover { background-color: #ea580c; border-color: #ea580c; }
        .close-btn, .back-to-topics-btn, .back-btn { background-color: var(--button-secondary-bg); color: white; border-color: var(--button-secondary-bg); } .close-btn:hover, .back-to-topics-btn:hover, .back-btn:hover { background-color: var(--button-secondary-hover-bg); border-color: var(--button-secondary-hover-bg); }
        .reset-data-btn { background-color: var(--incorrect-border); color: var(--incorrect-text); border-color: var(--incorrect-border); } body.dark-theme .reset-data-btn { color: white; } .reset-data-btn:hover { filter: brightness(1.1); }

        .hidden { display: none !important; }

        /* Error Message */
        .error-display { padding: 30px; text-align: center; background-color: var(--incorrect-bg); border: 1px solid var(--incorrect-border); border-radius: 8px; }
        .error-message { color: var(--incorrect-text); font-weight: 500; margin-bottom: 20px; }

        /* Results */
        .results-container { padding: 20px 0; text-align: center; }
        .results-header { font-size: 28px; font-weight: 600; margin-bottom: 30px; color: var(--text-heading); }
        .results-score { margin: 30px 0 40px 0; }
        .score-circle { width: 150px; height: 150px; border-radius: 50%; background-color: var(--feedback-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; border: 8px solid var(--accent-color); box-shadow: 0 0 20px color-mix(in srgb, var(--accent-color) 25%, transparent), inset 0 0 10px color-mix(in srgb, var(--accent-color) 15%, transparent); transition: border-color 0.3s ease; }
        .score-number { font-size: 44px; font-weight: bold; color: var(--text-heading); line-height: 1; }
        .score-percent-sign { font-size: 20px; font-weight: 500; color: var(--text-muted); margin-top: 4px; }
        .results-details { max-width: 500px; margin: 0 auto 35px auto; text-align: left; background-color: var(--feedback-bg); padding: 20px 30px; border-radius: 10px; border: 1px solid var(--feedback-border); box-shadow: 0 2px 5px var(--shadow-color); }
        .results-details p { margin: 12px 0; font-size: 16px; color: var(--text-color); display: flex; align-items: center; gap: 10px; }
        .results-details p strong { color: var(--text-heading); min-width: 80px; display: inline-block; font-weight: 600; }
        .results-details p .detail-value { color: var(--text-muted); font-weight: 500; }
        .results-details p .detail-icon { font-size: 18px; color: var(--accent-color); width: 20px; text-align: center; }

        /* Review Answers */
        .review-container { padding: 10px 0; }
        .question-review { padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border-color); border-left-width: 5px; background-color: var(--container-bg); }
        .question-review.correct { border-left-color: var(--correct-border); }
        .question-review.incorrect { border-left-color: var(--incorrect-border); }
        .question-review.partial { border-left-color: var(--partial-border); }
        .review-question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .review-question-number { font-weight: 600; color: var(--text-heading); font-size: 16px; }
        .review-status { font-weight: 600; font-size: 14px; padding: 3px 8px; border-radius: 4px; text-align: center; }
        .question-review.correct .review-status { color: var(--correct-text); background-color: var(--correct-bg); }
        .question-review.incorrect .review-status { color: var(--incorrect-text); background-color: var(--incorrect-bg); }
        .question-review.partial .review-status { color: var(--partial-text); background-color: var(--partial-bg); }
        .review-question-text { margin-bottom: 15px; font-size: 16px; color: var(--text-color); }
        .review-mc-answer, .review-matching-answer, .review-ordering-answer { background-color: var(--feedback-bg); padding: 15px; border-radius: 6px; border: 1px solid var(--feedback-border); margin-top: 15px; }
        .review-mc-answer p, .review-matching-answer p, .review-ordering-answer p { margin: 8px 0; font-size: 15px; color: var(--text-color); }
        .review-mc-answer p strong, .review-matching-answer p strong, .review-ordering-answer p strong { color: var(--text-heading); margin-right: 5px; display: inline-block; min-width: 110px; }
        .review-mc-answer .correct-answer-text, .review-matching-answer .correct-answer-text, .review-ordering-answer .correct-answer-text { color: var(--correct-text); font-weight: 500; }
        .review-mc-answer .user-answer-text.incorrect { color: var(--incorrect-text); text-decoration: line-through; }
        .review-mc-answer .user-answer-text.correct { color: var(--correct-text); font-weight: 500; }
        .review-matching-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .review-matching-column { flex: 1; min-width: 200px;}
        .review-matching-column div { padding: 5px 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--container-bg); }
        .review-matched-pair-correct { background-color: var(--correct-bg) !important; border-color: var(--correct-border) !important; color: var(--correct-text) !important; }
        .review-matched-pair-incorrect { background-color: var(--incorrect-bg) !important; border-color: var(--incorrect-border) !important; }
        /* NOTE: The following rules for '.review-matched-pair-incorrect span' are standard CSS and were correct */
        body.dark-theme .review-matched-pair-incorrect span { color: var(--incorrect-text) !important; opacity: 0.7; }
        body.dark-theme .review-matched-pair-incorrect span + span { color: var(--correct-text) !important; opacity: 1; }
        body:not(.dark-theme) .review-matched-pair-incorrect span { color: var(--incorrect-text) !important; opacity: 0.7; }
        body:not(.dark-theme) .review-matched-pair-incorrect span + span { color: var(--correct-text) !important; opacity: 1; }
        .review-ordering-list { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
        .review-ordering-list-item { display: flex; align-items: center; padding: 6px 10px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--container-bg); }
        .review-order-number { font-weight: 600; margin-right: 8px; }
        .review-order-correct { color: var(--correct-text); }
        .review-order-incorrect { color: var(--incorrect-text); text-decoration: line-through; opacity: 0.8; }

        /* Settings Modal */
        #settings-modal { position: fixed; inset: 0; background-color: var(--modal-overlay-bg); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #settings-modal.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--modal-bg); padding: 25px 30px; border-radius: 12px; box-shadow: 0 5px 20px var(--shadow-color); width: 90%; max-width: 400px; border: 1px solid var(--border-color); position: relative; transform: scale(0.95); transition: transform 0.3s ease; }
        #settings-modal.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 20px; font-weight: 600; color: var(--text-heading); }
        .modal-close-btn { font-size: 24px; background: none; border: none; color: var(--text-muted); cursor: pointer; line-height: 1; padding: 0 5px; }
        .modal-section { margin-bottom: 20px; }
        .modal-section h4 { font-size: 16px; font-weight: 500; color: var(--text-heading); margin: 0 0 12px 0; }
        .theme-options label { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; font-size: 15px; color: var(--text-color); }
        .theme-options input[type="radio"] { accent-color: var(--accent-color); }
        .modal-footer { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: right; }

        /* --- END OF styles.css --- */
    </style>
</head>
<body>

    <!-- Welcome View -->
    <!-- TODO: Replace [Name], [Names] placeholders below -->
    <div id="welcome-view">
        <h1>Welcome!</h1> <p>Practice makes perfect.</p>
        <div class="info-section"><strong>By:</strong><span>[Name]</span></div>
        <div class="info-section"><strong>Testers:</strong><span>[Names]</span></div>
        <div class="info-section"><strong>Mentions:</strong><span>[Names]</span></div>
        <button class="btn submit-btn get-started-btn">Start</button>
    </div>

    <!-- Main Container -->
    <div class="container initially-hidden">
        <div class="header">
            <h1>Question Bank</h1> <button id="settings-btn" title="Settings">⚙️</button>
        </div>
        <div class="nav-section">
             <div class="subjects">
                <button class="nav-btn" data-subject="اللغة العربية"><span>📚</span> اللغة العربية</button>
                <button class="nav-btn active" data-subject="english"><span>🌎</span> English</button>
                <button class="nav-btn" data-subject="التاريخ"><span>📜</span> التاريخ</button>
                <button class="nav-btn" data-subject="دين"><span>📖</span> دين</button>
            </div>
            <div class="secondary-nav">
                 <div class="semester-toggle">
                     <button class="semester-btn active" data-semester="first" id="semester-btn-first">First Semester</button>
                     <button class="semester-btn" data-semester="second" id="semester-btn-second">Second Semester</button>
                 </div>
             </div>
        </div>
        <div id="content"></div>
        <div id="quiz-view" class="hidden">
            <div id="quiz-header">
                <h2 id="quiz-title">Quiz</h2>
                <button class="btn back-to-topics-btn" id="back-to-topics-btn" onclick="showTopicList()"><span>⬅️</span> <span class="btn-text">Back to Topics</span></button>
            </div>
            <div id="quiz-container"></div>
            <div id="feedback-container" class="feedback-container hidden"></div>
            <div id="quiz-buttons-container" class="quiz-buttons"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden">
        <div class="modal-content">
            <div class="modal-header"> <h3 class="modal-title">Settings</h3> <button class="modal-close-btn" onclick="toggleSettingsModal(false)">×</button> </div>
            <div class="modal-body">
                <div class="modal-section"> <h4>Theme</h4> <div class="theme-options"> <label><input type="radio" name="theme" value="light"> Light ☀️</label> <label><input type="radio" name="theme" value="dark"> Dark 🌙</label> </div> </div>
                <div class="modal-section"> <h4>Data</h4> <button class="btn reset-data-btn" id="reset-data-button">Reset Data</button> <p style="font-size:12px;color:var(--text-muted);margin-top:8px;">Clears theme, welcome status, and stats.</p> </div>
            </div>
            <div class="modal-footer"> <button class="btn close-btn" id="settings-close-btn" onclick="toggleSettingsModal(false)">Close</button> </div>
        </div>
    </div>

    <script>
        // --- START OF topics.js ---
        // Data remains the same as provided...
        const topicsData = { // Added Placeholder Qs
            "english": { "first": { "title": "First Semester", "units": [ { "title": "Unit 1", "lessons": [ { "title": "Vocabulary & Grammar Basics", "questions": [ { "type": "multiple_choice", "question": "Device in 'curtain of night fell'?", "options": ["Simile", "Metaphor", "Alliteration", "Hyperbole"], "answer": "Metaphor" }, { "type": "multiple_choice", "question": "'Ambiguous' means:", "options": ["Clear", "Uncertain", "Definite", "Determined"], "answer": "Uncertain" }, { "type": "ordering", "question": "Order alphabetically:", "items": ["Banana", "Apple", "Cherry", "Date", "Fig"], "answer": ["Apple", "Banana", "Cherry", "Date", "Fig"] }, { "type": "matching", "question": "Match country and capital:", "prompts": ["France", "Japan", "Egypt", "Brazil", "Canada"], "matches": ["Cairo", "Tokyo", "Paris", "Brasília", "Ottawa"], "answer": { "0": 2, "1": 1, "2": 0, "3": 3, "4": 4 } }, { "type": "ordering", "question": "Order tea steps:", "items": ["Add tea bag", "Boil water", "Pour water"], "answer": ["Boil water", "Add tea bag", "Pour water"] } ] }, { "title": "Past & Present Tenses & Question Tags", "questions": [ { "type": "multiple_choice", "question": "Correct tense: 'She ___ school.'", "options": ["go", "goes", "going", "went"], "answer": "goes" }, { "type": "multiple_choice", "question": "Correct tag: 'You're coming, ___?'", "options": ["aren't you", "don't you", "isn't you", "won't you"], "answer": "aren't you" } ] } ] }, { "title": "Unit 2", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Future Forms", "questions": [] } ] }, { "title": "Unit 3", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Habits & Clauses", "questions": [] } ] }, { "title": "Unit 4", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Narration & Inversion", "questions": [] } ] } ] }, "second": { "title": "Second Semester", "units": [ { "title": "Unit 1", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modal & Related & Articles", "questions": [] } ] }, { "title": "Unit 2", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Reported Speech & Reporting Verbs", "questions": [] } ] }, { "title": "Unit 3", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "The Passive", "questions": [] } ] }, { "title": "Unit 4", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Conditionals & Modals", "questions": [] } ] }, { "title": "Unit 5", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modals & Clauses", "questions": [] } ] } ] } },
            "اللغة العربية": { "first": { "title": "الفصل الأول", "units": [ { "title": "الوحدة الأولى", "lessons": [ { "title": "من القيم الإنسانية في القرآن", "questions": [ {"type": "multiple_choice", "question": "ما معنى كلمة 'البر' في قوله تعالى 'لن تنالوا البر حتى تنفقوا مما تحبون'؟", "options": ["الخير", "الصدق", "العدل", "الوفاء"], "answer": "الخير"}, {"type": "ordering", "question": "رتب مراحل الوحي حسب نزولها:", "items": ["اقرأ باسم ربك", "المدثر", "الفاتحة"], "answer": ["اقرأ باسم ربك", "المدثر", "الفاتحة"]}, {"type": "matching", "question": "صل بين المصطلح وتعريفه:", "prompts": ["التجويد", "التفسير", "الناسخ والمنسوخ"], "matches": ["علم كيفية النطق الصحيح للقرآن", "علم بيان معاني القرآن", "علم الآيات التي تغير حكمها"], "answer": {"0": 0, "1": 1, "2": 2}} ] }, { "title": "اسلوب الطلب وجوابه المجزوم والتشبيه المفرد", "questions": [] } ] }, { "title": "الوحدة الثانية", "lessons": [ { "title": "عمانيات", "questions": [] }, { "title": "صور الفاعل والتشبيه التمثيلي", "questions": [] } ] }, { "title": "الوحدة الثالثة", "lessons": [ { "title": "الزهايمر-الخرف المبكر", "questions": [] }, { "title": "صور المبتدأ والخبر والجملة الخبرية والإنشائية", "questions": [] } ] }, { "title": "الوحدة الرابعة", "lessons": [ { "title": "الإعلام ومشروع النهوض باللغة العربية", "questions": [] }, { "title": "المفعول معه والأمر", "questions": [] } ] }, { "title": "الوحدة الخامسة", "lessons": [ { "title": "التعليم التقني بوابة المستقبل في عالم متغير", "questions": [] }, { "title": "انواع ما والإستفهام", "questions": [] } ] } ] }, "second": { "title": "الفصل الثاني", "units": [ { "title": "الوحدة الأولى", "lessons": [ { "title": "في فتح القدس", "questions": [] }, { "title": "معاني حروف الجر والتشخيص", "questions": [] } ] }, { "title": "الوحدة الثانية", "lessons": [ { "title": "قصة-حفنة تمر", "questions": [] }, { "title": "اسم الفاعل واسم المفعول والطباق والمقابلة", "questions": [] } ] }, { "title": "الوحدة الثالثة", "lessons": [ { "title": "شاعرات من بلدي", "questions": [] }, { "title": "اسم الزمان واسم المكان وجمع التكسير (القلة والكثرة)", "questions": [] } ] }, { "title": "الوحدة الرابعة", "lessons": [ { "title": "من مقامات بديع الزمان الهمذاني", "questions": [] }, { "title": "مصدر المرة ومصدر الهيئة والبحر المتدارك", "questions": [] } ] }, { "title": "الوحدة الخامسة", "lessons": [ { "title": "الذكاء الاصطناعي-عالم جديد", "questions": [] }, { "title": "اسم الآلة", "questions": [] } ] } ] } },
             "التاريخ": { "first": { "title": "الفصل الأول", "units": [ { "title": "الأردن في العصور القديمة", "lessons": [ { "title": "الأردن في العصور الحجرية", "questions": [ {"type": "multiple_choice", "question": "أي موقع أثري في الأردن يعود للعصر الحجري الحديث ويشتهر بالتماثيل العينية؟", "options": ["عين غزال", "جاوا", "بيضا", "أم قيس"], "answer": "عين غزال"}, {"type": "ordering", "question": "رتب العصور الحجرية من الأقدم للأحدث:", "items": ["الحجري الحديث", "الحجري القديم", "الحجري الوسيط"], "answer": ["الحجري القديم", "الحجري الوسيط", "الحجري الحديث"]}, ] }, { "title": "الأردن في العصر الحديدي", "questions": [] }, { "title": "مملكة الأنباط", "questions": [] }, { "title": "مظاهر الحضارة اليونانية في الأردن", "questions": [] }, { "title": "مظاهر الحضارة الرومانية-البيزنطية في الأردن", "questions": [] } ] }, { "title": "الأردن في صدر الإسلام", "lessons": [ { "title": "الأردن في صدر الإسلام", "questions": [] }, { "title": "الأردن في العصر الأموي", "questions": [] }, { "title": "الأردن في العصر العباسي", "questions": [] }, { "title": "الأردن خلال حملات الفرنجة", "questions": [] }, { "title": "الأردن في العصر الأيوبي", "questions": [] }, { "title": "الأردن في العصر المملوكي", "questions": [] } ] }, { "title": "الأردن في العصر الحديث", "lessons": [ { "title": "الأوضاع السياسية والإدارية في الأردن في العهد العثماني", "questions": [] }, { "title": "الأوضاع الإجتماعية والإقتصادية الأردن في العهد العثماني", "questions": [] }, { "title": "الثورة العربية الكبرى", "questions": [] }, { "title": "الأردن في عهد المملكة العربية السورية والحكومات المحلية", "questions": [] } ] } ] }, "second": { "title": "الفصل الثاني", "units": [ { "title": "الحياة السياسية في الأردن", "lessons": [ { "title": "تأسيس الإمارة الأردنية", "questions": [] }, { "title": "استقلال المملكة الأردنية الهاشمية", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1948-1957)", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1958-1999)", "questions": [] }, { "title": "الحياة السياسية في الأردن منذ 1999", "questions": [] }, { "title": "الأردن والعلاقات العربية والدولية", "questions": [] }, { "title": "القوات المسلحة الأردنية - الجيش العربي", "questions": [] }, { "title": "الأجهزة الأمنية الأردنية", "questions": [] } ] }, { "title": "الحياة الاقتصادية في الأردن", "lessons": [ { "title": "الحياة الاقتصادية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1951-1967)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1968-1999)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن منذ عام 1999", "questions": [] } ] }, { "title": "الحياة الاجتماعية في الأردن", "lessons": [ { "title": "الحياة الاجتماعية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن بين عامي (1951-1999)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن منذ عام 1999", "questions": [] } ] }, { "title": "التعليم والثقافة في الأردن", "lessons": [ { "title": "التعليم العام في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1951-1987)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1988-2024)", "questions": [] }, { "title": "التعليم العالي والبحث العلمي في الأردن منذ عام 1951", "questions": [] }, { "title": "الحياة الثقافية في الأردن في عهد الإمارة", "questions": [] }, { "title": "الحياة الثقافية في الأردن منذ عام 1946", "questions": [] } ] }, { "title": "الأردن والقضية الفلسطينية", "lessons": [ { "title": "موقف الأردن من القضية الفلسطينية بين عامي (1916-1951)", "questions": [] }, { "title": "موقف الأردن من القضية الفلسطينية منذ عام 1951", "questions": [] }, { "title": "الوصاية والإعمار الهاشمي للمقدسات الدينية في القدس", "questions": [] } ] } ] } },
             "دين": { "first": { "title": "الفصل الأول", "units": [ { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة آل عمران (102-105)", "questions": [ {"type": "multiple_choice", "question": "ما هو الأمر الذي نهى الله عنه في قوله تعالى 'ولا تفرقوا'؟", "options": ["التعصب", "الخلاف المذموم المؤدي للعداوة", "الاختلاف الفقهي", "ترك الصلاة"], "answer": "الخلاف المذموم المؤدي للعداوة"}, {"type": "multiple_choice", "question": "ما المقصود بـ 'حبل الله' في الآية؟", "options": ["القرآن والسنة", "الصلاة", "الزكاة", "الحج"], "answer": "القرآن والسنة"} ] }, { "title": "حديث اتقاء الشبهات", "questions": [] }, { "title": "من صور الضلال", "questions": [] }, { "title": "كرامة الإنسان في الشريعة", "questions": [] }, { "title": "الزواج-مشروعيته ومقدماته", "questions": [] }, { "title": "الجهاد في الإسلام", "questions": [] } ] }, { "title": "الوحدة الثانية", "lessons": [ { "title": "جهود علماء المسلمين في خدمة القرآن", "questions": [] }, { "title": "العزيمة والرخصة", "questions": [] }, { "title": "معركة مؤتة (8 هجري)", "questions": [] }, { "title": "المحرمات من النساء", "questions": [] }, { "title": "التعايش الإنساني", "questions": [] }, { "title": "الحقوق الإجتماعية للمرأة في الإسلام", "questions": [] } ] }, { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة آل عمران (169-174)", "questions": [] }, { "title": "حديث - رضا الله تعالى", "questions": [] }, { "title": "فتح مكة (8 هجري)", "questions": [] }, { "title": "من خصائص الشريعة - الإيجابية", "questions": [] }, { "title": "شروط صحة عقد الزواج", "questions": [] }, { "title": "الحقوق المالية للمرأة في الإسلام", "questions": [] } ] }, { "title": "الوحدة الرابعة", "lessons": [ { "title": "سورة الروم (21-24)", "questions": [] }, { "title": "مكانة السنة النبوية في التشريع", "questions": [] }, { "title": "مراعاة الأعراف في الشريعة", "questions": [] }, { "title": "حقوق الزوجين", "questions": [] }, { "title": "تنظيم النسل وتحديده", "questions": [] }, { "title": "الأمن الغذائي في الإسلام", "questions": [] }, { "title": "الإسلام والوحدة الوطنية", "questions": [] } ] } ] }, "second": { "title": "الفصل الثاني", "units": [ { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة البقرة (284-286)", "questions": [] }, { "title": "دلائل وجود الله تعالى", "questions": [] }, { "title": "إعجاز القرآن الكريم", "questions": [] }, { "title": "الأمر بالمعروف والنهي عن المنكر", "questions": [] }, { "title": "اليوم الآخر - احداثه وآثار الإيمان به", "questions": [] }, { "title": "الإجتهاد في الإسلام", "questions": [] } ] }, { "title": "الوحدة الثانية", "lessons": [ { "title": "سورة الأعراف (31-34)", "questions": [] }, { "title": "مراعاة المصالح في الشريعة", "questions": [] }, { "title": "جهود علماء المسلمين في الحفاظ على السنة النبوية", "questions": [] }, { "title": "حديث - منهج الإسلام في الحياة", "questions": [] }, { "title": "رسائل النبي الى الملوك والزعماء في عصره", "questions": [] }, { "title": "يوم تبوك (9 هجري)", "questions": [] }, { "title": "الحقوق السياسية للمرأة في الإسلام", "questions": [] } ] }, { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة الفرقان (63-77)", "questions": [] }, { "title": "الطلاق", "questions": [] }, { "title": "العدة", "questions": [] }, { "title": "الوصية في الشريعة", "questions": [] }, { "title": "الميراث في الشريعة", "questions": [] }, { "title": "من خصائص الشريعة - الوسطية", "questions": [] }, { "title": "مجالات الوقف ودورها في التنمية", "questions": [] } ] }, { "title": "الوحدة الرابعة", "lessons": [ { "title": "حديث - مفهوم الإفلاس بين الدنيا والآخرة", "questions": [] }, { "title": "مقاصد الشريعة", "questions": [] }, { "title": "منهج الإسلام في مكافحة الجريمة", "questions": [] }, { "title": "من وصايا النبي في حجة الوداع", "questions": [] }, { "title": "المسؤولية المجتمعية في الإسلام", "questions": [] }, { "title": "حقوق الإنسان بين الإسلام والإعلان العالمي لحقوق الإنسان", "questions": [] } ] } ] } }
        };

        function generateSemesterContent(subject, semester) {
            const sanitizedSubject = subject.replace(/\s+/g, '-'); const id = `${sanitizedSubject}-${semester}`;
            if (!topicsData[subject]?.[semester]) return `<div id="${id}" class="semester-content"><div class="section"><p>Unavailable.</p></div></div>`;
            const semesterData = topicsData[subject][semester]; let html = `<div id="${id}" class="semester-content">`;
            html += `<div class="semester-title-container"><div class="unit-title">${semesterData.title}</div></div>`;
            if (!semesterData.units?.length) { html += `<div class="section"><p>No units.</p></div>`; }
            else { semesterData.units.forEach(unit => { if (unit?.title) { html += `<div class="section"><div class="section-title">${unit.title}</div>`; if (unit.lessons?.length) { unit.lessons.forEach(lesson => { if (lesson?.title) { const qCount = lesson.questions?.length || 0; const countText = qCount === 1 ? "1 Q" : `${qCount} Qs`; html += `<div class="section-content" data-subject="${subject}" data-semester="${semester}" data-unit="${unit.title}" data-lesson="${lesson.title}"> <span class="lesson-title-text">${lesson.title}</span> <span class="lesson-stats-display"></span> <span class="lesson-q-count">(${countText})</span> </div>`; } }); } else { html += `<p style="font-size:14px;color:var(--text-muted);">(No lessons)</p>`; } html += `</div>`; } }); } html += `</div>`; return html;
        }
        function generateAllContent() { let c = ''; const d = document.getElementById('content'); if (!d) return; Object.keys(topicsData).forEach(s => { Object.keys(topicsData[s]).forEach(sem => { c += generateSemesterContent(s, sem); }); }); d.innerHTML = c; }
        generateAllContent();
        // --- END OF topics.js ---
    </script>

    <script>
        // --- START OF questions.js ---
        let quizState = { currentQuestionIndex: 0, correctAnswers: 0, totalQuestions: 0, startTime: null, endTime: null, selectedAnswers: [], questions: [], originalQuestions: [], subject: '', unit: '', lesson: '', semester: '', matchingState: { selectedPromptElement: null, selectedMatchElement: null, userPairs: {} } }; // Added selectedMatchElement for RTL clarity
        let allLessonStats = {};

        const LS_THEME_KEY = 'quizAppTheme'; const LS_VISITED_KEY = 'quizAppVisited'; const LS_STATS_KEY = 'quizAppLessonStats';
        const RTL_SUBJECTS = ["اللغة العربية", "دين", "التاريخ"]; // <-- Define RTL subjects

        // --- UI String Translations (Expanded) ---
        const uiStrings = {
            en: {
                firstSemester: "First Semester", secondSemester: "Second Semester",
                backToTopics: "Back to Topics", submit: "Submit", next: "Next Question",
                viewResults: "View Results",
                resultsSubjectLabel: "Subject:", resultsSemesterLabel: "Semester:",
                resultsUnitLabel: "Unit:", resultsLessonLabel: "Lesson:", resultsCorrectLabel: "Correct:",
                resultsTimeLabel: "Time:",
                redoQuiz: "Redo Quiz", reviewAnswers: "Review Answers",
                backToResults: "Back to Results",
                settingsTitle: "Settings", settingsThemeHeading: "Theme",
                settingsLightMode: "Light Mode", settingsDarkMode: "Dark Mode", settingsDataHeading: "Data Management",
                settingsResetBtn: "Reset Saved Data", settingsResetInfo: "Clears theme, welcome status, and all saved lesson statistics.",
                settingsCloseBtn: "Close",
                matchingInstruction: "Click an item on the left, then its corresponding item on the right. Click a matched item again to deselect the pair.",
                orderingInstruction: "Select the correct order number ({num}) for each item.", // {num} will be replaced
                matchingItemsHeader: "Items", matchingMatchesHeader: "Matches",
                defaultErrorMessage: "Could not load questions for this lesson.",
                leaveQuizConfirm: "Leave the current quiz? Progress will be lost.",
                resetDataConfirm: "Reset all saved data (theme, stats)? This cannot be undone.",
                resetDataAlert: "Data has been reset. Reloading the page.",
                reviewStatusCorrect: "✓ Correct", reviewStatusIncorrect: "✗ Incorrect",
                reviewStatusPartial: "~ Partial ({correct}/{total})", reviewStatusUnanswered: "Unanswered",
                quizResultExcellent: "Excellent! 🎉", quizResultGreat: "Great Job! 👍",
                quizResultGood: "Good Effort! 💪", quizResultPractice: "Keep Practicing! 📚",
                quizResultNoQuestions: "No questions in this quiz.",
                quizTitlePrefix: "Quiz", reviewTitlePrefix: "Review"
            },
            ar: {
                 firstSemester: "الفصل الأول", secondSemester: "الفصل الثاني",
                 backToTopics: "العودة للمواضيع", submit: "إرسال", next: "السؤال التالي",
                 viewResults: "عرض النتائج",
                 resultsSubjectLabel: "المادة:", resultsSemesterLabel: "الفصل:",
                 resultsUnitLabel: "الوحدة:", resultsLessonLabel: "الدرس:", resultsCorrectLabel: "الصحيحة:",
                 resultsTimeLabel: "الوقت:",
                 redoQuiz: "إعادة الاختبار", reviewAnswers: "مراجعة الإجابات",
                 backToResults: "العودة للنتائج",
                 settingsTitle: "الإعدادات", settingsThemeHeading: "السمة",
                 settingsLightMode: "وضع فاتح", settingsDarkMode: "وضع داكن", settingsDataHeading: "إدارة البيانات",
                 settingsResetBtn: "إعادة تعيين البيانات", settingsResetInfo: "يمسح تفضيلات السمة وحالة شاشة الترحيب وجميع إحصائيات الدروس المحفوظة.",
                 settingsCloseBtn: "إغلاق",
                 matchingInstruction: "انقر على عنصر في القائمة الأولى، ثم على العنصر المقابل له في القائمة الثانية. انقر على زوج متطابق مرة أخرى لإلغاء التحديد.",
                 orderingInstruction: "حدد رقم الترتيب الصحيح ({num}) لكل عنصر.",
                 matchingItemsHeader: "العناصر", matchingMatchesHeader: "المطابقات",
                 defaultErrorMessage: "تعذر تحميل أسئلة هذا الدرس.",
                 leaveQuizConfirm: "هل تريد مغادرة الاختبار الحالي؟ سيتم فقدان التقدم.",
                 resetDataConfirm: "هل أنت متأكد من إعادة تعيين جميع البيانات المحفوظة (السمة، الإحصائيات)؟ لا يمكن التراجع عن هذا الإجراء.",
                 resetDataAlert: "تمت إعادة تعيين البيانات. جارٍ إعادة تحميل الصفحة.",
                 reviewStatusCorrect: "✓ صحيح", reviewStatusIncorrect: "✗ خطأ",
                 reviewStatusPartial: "~ جزئي ({correct}/{total})", reviewStatusUnanswered: "لم تتم الإجابة",
                 quizResultExcellent: "ممتاز! 🎉", quizResultGreat: "عمل رائع! 👍",
                 quizResultGood: "مجهود جيد! 💪", quizResultPractice: "استمر في الممارسة! 📚",
                 quizResultNoQuestions: "لا توجد أسئلة في هذا الاختبار.",
                 quizTitlePrefix: "اختبار", reviewTitlePrefix: "مراجعة"
            }
        };

        let contentElement, quizViewElement, quizTitleElement, quizContainerElement, feedbackContainerElement, quizButtonsContainerElement, matchingSvgElement, navSectionElement, welcomeViewElement, mainContainerElement, settingsModalElement, settingsButtonElement;
        let matchingArrowObserver = null; let resizeTimeout = null;

        // --- Utility Functions ---
        function shuffleArray(array) { const newArray=[...array]; for(let i=newArray.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[newArray[i],newArray[j]]=[newArray[j],newArray[i]];} return newArray; }
        function debounce(func,wait){ let timeout; return function(...args){const later=()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout=setTimeout(later,wait);}; }
        function formatTime(s){if(s===null||s<0)return'N/A';const m=Math.floor(s/60),c=Math.floor(s%60);return m>0?`${m}m ${c}s`:`${c}s`;}
        function getLessonStorageKey(s,sem,u,l){const c=str=>str.replace(/\s+/g,'_').replace(/-/g,'__');return`${c(s)}-${c(sem)}-${c(u)}-${c(l)}`;}
        function getCurrentLang() { return document.documentElement.lang || 'en'; }
        function getStrings() { return uiStrings[getCurrentLang()] || uiStrings.en; }

        // --- Lesson Stats Management ---
        function loadLessonStats(){try{const s=localStorage.getItem(LS_STATS_KEY);allLessonStats=s?JSON.parse(s):{};}catch(e){console.error("Fail stats load:",e);allLessonStats={};}}
        function saveLessonStats(subj,sem,unit,lesson,score,total,time){const k=getLessonStorageKey(subj,sem,unit,lesson);const e=allLessonStats[k];let u=!1;if(!e){allLessonStats[k]={bestScore:score,totalQuestions:total,bestTime:time};u=!0;}else{if(score>e.bestScore){e.bestScore=score;e.bestTime=time;e.totalQuestions=total;u=!0;}else if(score===e.bestScore&&time<e.bestTime){e.bestTime=time;u=!0;}if(total!==e.totalQuestions){e.totalQuestions=total;u=!0;}}if(u)try{localStorage.setItem(LS_STATS_KEY,JSON.stringify(allLessonStats));}catch(e){console.error("Fail stats save:",e);}}
        function updateLessonBoxDisplays(){const a=document.querySelector('.semester-content.active');if(!a)return;const l=a.querySelectorAll('.section-content');l.forEach(b=>{const s=b.dataset.subject,sem=b.dataset.semester,u=b.dataset.unit,les=b.dataset.lesson,dS=b.querySelector('.lesson-stats-display'),qC=b.querySelector('.lesson-q-count');if(!s||!sem||!u||!les||!dS)return;const k=getLessonStorageKey(s,sem,u,les),st=allLessonStats[k];b.classList.remove('lesson-complete-perfect','lesson-complete-imperfect');dS.textContent='';if(qC)qC.style.display='';if(st){const sT=`🏆 ${st.bestScore}/${st.totalQuestions}`,tT=`⏱️ ${formatTime(st.bestTime)}`;dS.textContent=`${sT} | ${tT}`;if(st.bestScore===st.totalQuestions&&st.totalQuestions>0)b.classList.add('lesson-complete-perfect');else b.classList.add('lesson-complete-imperfect');}else{if(qC)qC.style.display='';}});}

        // --- UI Language Update ---
        function updateUiLanguage(lang = 'en') {
            const strings = uiStrings[lang] || uiStrings.en; // Use provided lang or fallback
            const isRTL = lang === 'ar';
            document.documentElement.lang = lang; // Set page language

            // Helper to set text, handling potential inner spans for buttons
            const setText = (elementId, textKey, options = {}) => {
                const element = document.getElementById(elementId);
                let text = strings[textKey] || uiStrings.en[textKey] || ''; // Fallback text
                 if (options.num !== undefined) { text = text.replace('{num}', `1-${options.num}`); } // Placeholder

                if (element) {
                    const textSpan = element.querySelector('.btn-text');
                    if (textSpan) {
                        textSpan.textContent = text;
                        // Icon direction handled by CSS flex-direction generally
                    } else {
                        element.textContent = text; // Set text directly if no span
                    }
                } else if (options.selector) { // Allow using selectors for non-ID elements
                     const elements = document.querySelectorAll(options.selector);
                     elements.forEach(el => { el.textContent = text; });
                }
            };
            // Helper for results details labels
             const setDetailLabel = (key, textKey) => {
                 const text = strings[textKey] || uiStrings.en[textKey] || '';
                 const pElement = document.querySelector(`.results-details p[data-detail-key="${key}"] strong`);
                 if (pElement) pElement.textContent = text;
             };

            // --- Update Static & Dynamic Elements ---
            setText('semester-btn-first', 'firstSemester');
            setText('semester-btn-second', 'secondSemester');
            setText('settings-close-btn', 'settingsCloseBtn');
            setText('reset-data-button', 'settingsResetBtn');

            // Buttons that might exist depending on view
            setText('back-to-topics-btn', 'backToTopics');
            setText('submit-btn', 'submit');
            const nextBtn = document.getElementById('next-btn');
            if (nextBtn) {
                 const nextBtnTextKey = (quizState.currentQuestionIndex === quizState.totalQuestions - 1 && quizState.totalQuestions > 0) ? 'viewResults' : 'next';
                 setText('next-btn', nextBtnTextKey);
            }
            setText('redo-btn', 'redoQuiz');
            setText('review-btn', 'reviewAnswers');
            setText('back-to-topics-btn-results', 'backToTopics');
            setText('back-btn', 'backToResults');
            setText('back-to-topics-btn-review', 'backToTopics');
            setText('back-to-topics-btn-error', 'backToTopics');

            // Quiz Title (handle different states)
            if (quizTitleElement) {
                if (quizContainerElement && quizContainerElement.querySelector('.results-container')) {
                    quizTitleElement.textContent = strings.viewResults || 'Quiz Results';
                } else if (quizContainerElement && quizContainerElement.querySelector('.review-container')) {
                    quizTitleElement.textContent = `${strings.reviewTitlePrefix || 'Review'}: ${quizState.lesson || ''}`;
                } else if (quizContainerElement && quizContainerElement.querySelector('.error-display')) {
                     quizTitleElement.textContent = strings.defaultErrorMessage || 'Error'; // Or a specific error title key
                } else if (quizState.lesson) {
                    quizTitleElement.textContent = `${strings.quizTitlePrefix || 'Quiz'}: ${quizState.lesson}`;
                }
            }


            // Modal text
            const modal = document.getElementById('settings-modal');
            if(modal) {
                setText('settings-modal .modal-title', 'settingsTitle', { selector: '#settings-modal .modal-title' });
                setText('settings-modal .modal-section:nth-of-type(1) h4', 'settingsThemeHeading', { selector: '#settings-modal .modal-section:nth-of-type(1) h4' });
                const lightLabel = modal.querySelector('input[value="light"]')?.parentElement; if(lightLabel) lightLabel.childNodes[lightLabel.childNodes.length-1].nodeValue = ` ${strings.settingsLightMode || 'Light Mode'} ☀️`;
                const darkLabel = modal.querySelector('input[value="dark"]')?.parentElement; if(darkLabel) darkLabel.childNodes[darkLabel.childNodes.length-1].nodeValue = ` ${strings.settingsDarkMode || 'Dark Mode'} 🌙`;
                setText('settings-modal .modal-section:nth-of-type(2) h4', 'settingsDataHeading', { selector: '#settings-modal .modal-section:nth-of-type(2) h4' });
                setText('settings-modal .modal-section:nth-of-type(2) p', 'settingsResetInfo', { selector: '#settings-modal .modal-section:nth-of-type(2) p' });
            }

             // Results Details Labels
             setDetailLabel('subject', 'resultsSubjectLabel');
             setDetailLabel('semester', 'resultsSemesterLabel');
             setDetailLabel('unit', 'resultsUnitLabel');
             setDetailLabel('lesson', 'resultsLessonLabel');
             setDetailLabel('correct', 'resultsCorrectLabel');
             setDetailLabel('time', 'resultsTimeLabel');

             // Instructions (if quiz view is active and elements exist)
             const matchingInstructions = document.querySelector('.matching-instructions');
             if(matchingInstructions) matchingInstructions.textContent = strings.matchingInstruction || '';

             const orderingInstructions = document.querySelector('.ordering-instructions');
             if(orderingInstructions) {
                 const numItems = quizState?.questions[quizState.currentQuestionIndex]?.items?.length || 0;
                 const instructionText = strings.orderingInstruction || '';
                 orderingInstructions.textContent = numItems > 0 ? instructionText.replace('{num}', `1-${numItems}`) : instructionText.replace('{num}', 'N/A');
             }

             // Matching Headers (if quiz view is active and elements exist)
             const itemsHeader = document.querySelector('#prompts-column h4');
             if (itemsHeader) itemsHeader.textContent = strings.matchingItemsHeader || 'Items';
             const matchesHeader = document.querySelector('#matches-column h4');
             if (matchesHeader) matchesHeader.textContent = strings.matchingMatchesHeader || 'Matches';

             // Result Header Message
             const resultHeader = document.querySelector('.results-header');
             if (resultHeader) { // Only update if the results view is actually displayed
                 const score = quizState.totalQuestions > 0 ? (quizState.correctAnswers / quizState.totalQuestions) * 100 : 0;
                 let msgKey = 'quizResultPractice'; // Default
                 if (quizState.totalQuestions === 0) msgKey = 'quizResultNoQuestions';
                 else if (score >= 90) msgKey = 'quizResultExcellent';
                 else if (score >= 70) msgKey = 'quizResultGreat';
                 else if (score >= 50) msgKey = 'quizResultGood';
                 resultHeader.textContent = strings[msgKey] || '';
             }
        }


        // --- RTL and Theme Management ---
        function setRtlLayout(enable) {
            if (mainContainerElement) {
                const lang = enable ? 'ar' : 'en';
                mainContainerElement.classList.toggle('rtl-layout', enable);
                // Only call updateUiLanguage IF the language actually changed
                if (document.documentElement.lang !== lang) {
                    updateUiLanguage(lang);
                }
            }
        }
        function applyTheme(t){document.body.classList.toggle('dark-theme',t==='dark');const r=settingsModalElement?.querySelectorAll('input[name="theme"]');if(r)r.forEach(rd=>rd.checked=rd.value===t);}
        function handleThemeChange(e){const n=e.target.value;applyTheme(n);localStorage.setItem(LS_THEME_KEY,n);}
        function loadAndApplyTheme(){const s=localStorage.getItem(LS_THEME_KEY);const c=s||'dark';applyTheme(c);if(!s)localStorage.setItem(LS_THEME_KEY,'dark');}
        function toggleSettingsModal(s){if(!settingsModalElement)return;if(s){const c=localStorage.getItem(LS_THEME_KEY)||'dark';const r=settingsModalElement.querySelectorAll('input[name="theme"]');r.forEach(rd=>rd.checked=rd.value===c);settingsModalElement.classList.remove('hidden');setTimeout(()=>settingsModalElement.classList.add('visible'),10);}else{settingsModalElement.classList.remove('visible');setTimeout(()=>settingsModalElement.classList.add('hidden'),300);}}
        function resetSavedData(){
            const strings = getStrings(); // Get current language strings
            const confirmMsg = strings.resetDataConfirm || 'Confirm Reset?';
            if (confirm(confirmMsg)) {
                localStorage.removeItem(LS_THEME_KEY);
                localStorage.removeItem(LS_VISITED_KEY);
                localStorage.removeItem(LS_STATS_KEY);
                allLessonStats = {};
                alert(strings.resetDataAlert || 'Data reset. Reloading.');
                location.reload();
            }
        }

        // --- Welcome Screen Logic ---
        function handleWelcome(){if(!welcomeViewElement||!mainContainerElement)return;const h=localStorage.getItem(LS_VISITED_KEY);if(h){welcomeViewElement.classList.add('hidden');mainContainerElement.classList.remove('initially-hidden');setTimeout(()=>{mainContainerElement.style.opacity=1;},50);}else{welcomeViewElement.classList.remove('hidden');mainContainerElement.classList.add('initially-hidden');mainContainerElement.style.opacity=0;const b=welcomeViewElement.querySelector('.get-started-btn');if(b)b.addEventListener('click',()=>{localStorage.setItem(LS_VISITED_KEY,'true');welcomeViewElement.classList.add('hidden');mainContainerElement.classList.remove('initially-hidden');setTimeout(()=>{mainContainerElement.style.opacity=1;},50);},{once:true});}}

        // --- DOM Ready Listener ---
        document.addEventListener('DOMContentLoaded',()=>{
            // Get DOM elements
            welcomeViewElement=document.getElementById('welcome-view');mainContainerElement=document.querySelector('.container');contentElement=document.getElementById('content');quizViewElement=document.getElementById('quiz-view');quizTitleElement=document.getElementById('quiz-title');quizContainerElement=document.getElementById('quiz-container');feedbackContainerElement=document.getElementById('feedback-container');quizButtonsContainerElement=document.getElementById('quiz-buttons-container');navSectionElement=document.querySelector('.nav-section');settingsButtonElement=document.getElementById('settings-btn');settingsModalElement=document.getElementById('settings-modal');
            // Initial Setup
            loadAndApplyTheme();loadLessonStats();handleWelcome();
            // Set initial UI language and RTL based on default subject or saved preference (if any)
             const initialSubjectBtn = document.querySelector('.nav-btn.active');
             const initialSubject = initialSubjectBtn?.dataset.subject || 'english'; // Default to english if somehow none active
             setRtlLayout(RTL_SUBJECTS.includes(initialSubject)); // Sets layout AND calls updateUiLanguage

            // Event Listeners
            if(settingsButtonElement)settingsButtonElement.addEventListener('click',()=>toggleSettingsModal(true));
            if(settingsModalElement){const r=settingsModalElement.querySelectorAll('input[name="theme"]');r.forEach(rd=>rd.addEventListener('change',handleThemeChange));const b=document.getElementById('reset-data-button');if(b)b.addEventListener('click',resetSavedData);settingsModalElement.addEventListener('click',(e)=>{if(e.target===settingsModalElement)toggleSettingsModal(false);});}

            // Subject/Semester Buttons
            document.querySelectorAll('.nav-btn[data-subject]').forEach(b=>{b.addEventListener('click',function(){
                const strings = getStrings();
                const confirmMsg = strings.leaveQuizConfirm || "Leave quiz?";
                if (!quizViewElement.classList.contains('hidden') && !confirm(confirmMsg)) return;
                showTopicList();
                document.querySelectorAll('.nav-btn[data-subject]').forEach(btn=>btn.classList.remove('active'));
                this.classList.add('active');
                updateContent(); // This will handle setRtlLayout and updateUiLanguage
            });});
            document.querySelectorAll('.semester-btn').forEach(b=>{b.addEventListener('click',function(){
                const strings = getStrings();
                const confirmMsg = strings.leaveQuizConfirm || "Leave quiz?";
                if (!quizViewElement.classList.contains('hidden') && !confirm(confirmMsg)) return;
                showTopicList();
                document.querySelectorAll('.semester-btn').forEach(btn=>btn.classList.remove('active'));
                this.classList.add('active');
                updateContent();
            });});

            // Lesson Click
            if(contentElement)contentElement.addEventListener('click',(e)=>{const l=e.target.closest('.section-content');if(l){
                const strings = getStrings();
                const confirmMsg = strings.leaveQuizConfirm || "Leave quiz?";
                if (!quizViewElement.classList.contains('hidden') && !confirm(confirmMsg)) return;
                // If they confirm or no quiz active, proceed
                if (!quizViewElement.classList.contains('hidden')) showTopicList(); // Clean up if leaving
                const s=l.dataset.subject,sem=l.dataset.semester,u=l.dataset.unit,les=l.dataset.lesson;
                handleSectionClick(s,sem,u,les);
            }});

            // Resize Listener
            window.addEventListener('resize',debounce(updateAllArrowPositions,250));

            // Initial content load if already visited
            if(localStorage.getItem(LS_VISITED_KEY))updateContent();
        });

        // --- View Management ---
        function showTopicList(){
            if(!mainContainerElement || !contentElement || !quizViewElement || !navSectionElement) return;
            const currentSubject = document.querySelector('.nav-btn.active')?.dataset.subject || 'english';
            const isRTL = RTL_SUBJECTS.includes(currentSubject);

            mainContainerElement.classList.remove('hidden');
            contentElement.classList.remove('hidden');
            quizViewElement.classList.add('hidden');
            navSectionElement.classList.remove('hidden');

            setRtlLayout(isRTL); // Ensure layout is correct for the topics list
            updateContent(); // Show correct list AND update stats display (calls updateUiLanguage if needed)

            // Clean up quiz-specific things
            if(matchingArrowObserver){matchingArrowObserver.disconnect();matchingArrowObserver=null;}
            if(matchingSvgElement&&matchingSvgElement.parentNode){matchingSvgElement.remove();matchingSvgElement=null;}
            quizState = {currentQuestionIndex:0,correctAnswers:0,totalQuestions:0,startTime:null,endTime:null,selectedAnswers:[],questions:[],originalQuestions:[],subject:'',unit:'',lesson:'',semester:'',matchingState:{selectedPromptElement:null, selectedMatchElement: null, userPairs:{}}};
            mainContainerElement.scrollIntoView({behavior:'smooth',block:'start'});
        }
        function showQuizView(){if(mainContainerElement&&contentElement&&quizViewElement&&navSectionElement){mainContainerElement.classList.remove('hidden');contentElement.classList.add('hidden');quizViewElement.classList.remove('hidden');navSectionElement.classList.add('hidden');quizViewElement.scrollIntoView({behavior:'smooth',block:'start'});}}

        // --- Core Functions ---
        function updateContent() { // Updates topic list view AND triggers stat/RTL display update
            const aSBtn = document.querySelector('.nav-btn[data-subject].active'); const aSemBtn = document.querySelector('.semester-btn.active');
            if (!aSBtn || !aSemBtn || !contentElement) return;
            const actSub = aSBtn.dataset.subject; const actSem = aSemBtn.dataset.semester;
            const sanSub = actSub.replace(/\s+/g, '-');
            const isRTL = RTL_SUBJECTS.includes(actSub);

            setRtlLayout(isRTL); // Set RTL based on ACTIVE subject, this calls updateUiLanguage

            contentElement.querySelectorAll('.semester-content').forEach(c=>c.classList.remove('active'));
            const cId = `${sanSub}-${actSem}`; const sCE = contentElement.querySelector(`#${cId}`);
            if (sCE) {
                sCE.classList.add('active');
                updateLessonBoxDisplays(); // Update stats display AFTER showing the correct semester
            } else {
                console.warn(`Semester content ID "#${cId}" not found.`);
                // Optionally display a message in the content area if needed
                // contentElement.innerHTML = `<p>Error: Content for ${actSub} - ${actSem} not found.</p>`;
            }
        }
        function handleSectionClick(subj,sem,unit,lesson){
            if(!subj||!sem||!unit||!lesson) {
                const strings = getStrings();
                alert(strings.defaultErrorMessage || "Error identifying topic."); // Use translated error
                return;
            }
            try{
                showQuizView();
                const oQ=getQuestions(subj,sem,unit,lesson);
                if(oQ?.length) {
                    startQuiz(subj,sem,unit,lesson,oQ);
                } else {
                    showError(subj,unit,lesson); // No questions found
                }
            } catch(e){
                console.error("Error handling section click:",e);
                showError(subj,unit,lesson, (getStrings().defaultErrorMessage || "Error loading quiz.")); // General error
            }
        }
        function startQuiz(subj,sem,unit,lesson,oQ){
            const sQ = shuffleArray(oQ);
            quizState = {currentQuestionIndex:0,correctAnswers:0,totalQuestions:sQ.length,startTime:new Date(),endTime:null,selectedAnswers:new Array(sQ.length).fill(null),questions:sQ,originalQuestions:oQ,subject:subj,unit:unit,lesson:lesson,semester:sem,matchingState:{selectedPromptElement:null, selectedMatchElement: null, userPairs:{}}};
            const isRTL = RTL_SUBJECTS.includes(subj);
            setRtlLayout(isRTL); // Set RTL for quiz, this calls updateUiLanguage if language changes
            if(quizTitleElement) {
                const strings = getStrings();
                quizTitleElement.textContent = `${strings.quizTitlePrefix || 'Quiz'}: ${lesson}`;
            }
            displayQuestion();
        }
        function displayQuestion(){
            if(!quizContainerElement||!feedbackContainerElement||!quizButtonsContainerElement)return;
            const cQ=quizState.questions[quizState.currentQuestionIndex]; if(!cQ){displayResults();return;}

            // Clear previous state
            quizContainerElement.innerHTML='';feedbackContainerElement.innerHTML='';feedbackContainerElement.classList.add('hidden');quizButtonsContainerElement.innerHTML='';
            if(matchingSvgElement&&matchingSvgElement.parentNode){matchingSvgElement.remove();matchingSvgElement=null;} if(matchingArrowObserver){matchingArrowObserver.disconnect();matchingArrowObserver=null;}

            const qW=document.createElement('div');qW.className='question-display-wrapper';
            const pT=document.createElement('div');pT.className='question-progress';pT.textContent=`Q ${quizState.currentQuestionIndex+1}/${quizState.totalQuestions}`;qW.appendChild(pT);
            const qT=document.createElement('p');qT.className='question-text';qT.innerHTML=`<strong>Q:</strong> ${cQ.question||'?'}`;qW.appendChild(qT);
            const tW=document.createElement('div');tW.className='question-type-wrapper';

            // Render based on type
            try{switch(cQ.type){case"matching":renderMatching(cQ,tW);requestAnimationFrame(setupArrowObserver);break;case"ordering":renderOrdering(cQ,tW);break;case"multiple_choice":default:renderMultipleChoice(cQ,tW);break;}}catch(e){console.error("Render error:",e);tW.innerHTML=`<p style="color:red;">Error displaying question.</p>`;} // Consider using translated error

            qW.appendChild(tW);quizContainerElement.appendChild(qW);

            // Add buttons
            const sB=document.createElement('button');sB.className='btn submit-btn';sB.id='submit-btn';sB.innerHTML=`<span class="btn-text"></span>`; sB.onclick=checkAnswer;
            const nB=document.createElement('button');nB.className='btn next-btn hidden';nB.id='next-btn';nB.innerHTML=`<span class="btn-text"></span>`; nB.onclick=nextQuestion;
            quizButtonsContainerElement.append(sB,nB);
            sB.disabled=true; // Disable initially
            // Enable submit only if it's not MC/Ordering/Matching (or specific logic handles enabling)
            if(cQ.type!=='multiple_choice'&&cQ.type!=='ordering'&&cQ.type!=='matching')sB.disabled=false;

            updateUiLanguage(getCurrentLang()); // Set button text and other UI elements for the current language
        }

        // --- Rendering Functions ---
        function renderMultipleChoice(q,c){if(!q.options?.length)return c.textContent='Err Opts';const oD=document.createElement('div');oD.className='options-container';q.options.forEach((o,i)=>{const id=`option-${i}`,l=document.createElement('label');l.className='option-label';l.htmlFor=id;const inp=document.createElement('input');inp.type='radio';inp.name='question-option';inp.value=i;inp.id=id;inp.className='option-input';inp.addEventListener('change',()=>{const s=document.getElementById('submit-btn');if(s)s.disabled=false;});const t=document.createElement('span');t.className='option-text';t.textContent=o;l.append(inp,t);oD.appendChild(l);});c.appendChild(oD);}

        function renderMatching(question, container) {
             if (!question.prompts?.length || !question.matches?.length || question.prompts.length !== question.matches.length) { container.textContent = 'Error: Matching data is invalid.'; return; } // Consider i18n

             const strings = getStrings();
             quizState.matchingState.userPairs = {}; // Reset pairs for this question
             quizState.matchingState.selectedPromptElement = null; // Reset selection
             quizState.matchingState.selectedMatchElement = null; // Reset selection

             const instr = document.createElement('p');
             instr.className = 'matching-instructions';
             instr.textContent = strings.matchingInstruction || ''; // Set instruction text
             container.appendChild(instr);

             const outer = document.createElement('div');
             outer.style.position = 'relative';
             outer.id = `matching-outer-${quizState.currentQuestionIndex}`;
             container.appendChild(outer);

             // Create SVG container *once* per matching question render
             matchingSvgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
             matchingSvgElement.id = 'matching-arrow-svg';
             matchingSvgElement.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="var(--accent-color)"/></marker></defs>';
             outer.appendChild(matchingSvgElement);

             const matchCont = document.createElement('div');
             matchCont.className = 'matching-container';
             matchCont.id = 'matching-cols';
             const promCol = document.createElement('div');
             promCol.className = 'matching-column';
             promCol.id = 'prompts-column';
             // Use translated header
             promCol.innerHTML = `<h4>${strings.matchingItemsHeader || 'Items'}</h4>`;
             const matCol = document.createElement('div');
             matCol.className = 'matching-column';
             matCol.id = 'matches-column';
             // Use translated header
             matCol.innerHTML = `<h4>${strings.matchingMatchesHeader || 'Matches'}</h4>`;

             // Shuffle matches for display
             const shuffledMatches = question.matches.map((text, originalIndex) => ({ text, originalIndex })).sort(() => 0.5 - Math.random());

             // Create Prompt items (Accessibility Enhanced)
             question.prompts.forEach((promptText, promptIndex) => {
                 const item = document.createElement('div');
                 item.className = 'matching-item prompt-item';
                 item.textContent = promptText;
                 item.dataset.index = promptIndex;
                 item.id = `prompt-${promptIndex}`;
                 item.tabIndex = 0; // Make focusable
                 item.onclick = handleMatchingClick;
                 item.onkeydown = (e) => { // Handle keyboard activation
                     if (e.key === 'Enter' || e.key === ' ') {
                         e.preventDefault(); // Prevent scrolling on space
                         handleMatchingClick(e);
                     }
                 };
                 promCol.appendChild(item);
             });

             // Create Match items (Accessibility Enhanced)
             shuffledMatches.forEach(matchObject => {
                 const item = document.createElement('div');
                 item.className = 'matching-item match-item';
                 item.textContent = matchObject.text;
                 item.dataset.index = matchObject.originalIndex; // Store original index
                 item.id = `match-${matchObject.originalIndex}`;
                 item.tabIndex = 0; // Make focusable
                 item.onclick = handleMatchingClick;
                 item.onkeydown = (e) => { // Handle keyboard activation
                     if (e.key === 'Enter' || e.key === ' ') {
                         e.preventDefault(); // Prevent scrolling on space
                         handleMatchingClick(e);
                     }
                 };
                 matCol.appendChild(item);
             });

             matchCont.append(promCol, matCol);
             outer.appendChild(matchCont);

             // updateUiLanguage(getCurrentLang()); // Already called by displayQuestion or setRtlLayout
        }

        function renderOrdering(q,c){
            if(!q.items?.length) { c.textContent='Error: Ordering data invalid.'; return; } // i18n

            const strings = getStrings();
            const numItems = q.items.length;

            const instr = document.createElement('p');
            instr.className='ordering-instructions';
            const instructionText = strings.orderingInstruction || ''; // Get base text
            instr.textContent = numItems > 0 ? instructionText.replace('{num}', `1-${numItems}`) : instructionText.replace('{num}', 'N/A'); // Add numbers
            c.appendChild(instr);

            const oC=document.createElement('div');
            oC.className='ordering-container';
            oC.id='ordering-list';

            // Enable/disable submit based on all selects having a value
            const checkCompletion=()=>{
                const allSelects=oC.querySelectorAll('.ordering-select');
                const allSelected = Array.from(allSelects).every(select => select.value !== "");
                const submitBtn=document.getElementById('submit-btn');
                if(submitBtn) submitBtn.disabled=!allSelected;
            };

            // Shuffle items for display
            const shuffledItems=q.items.map((text,originalIndex)=>({text,originalIndex})).sort(()=>.5-Math.random());

            shuffledItems.forEach(({text: itemText, originalIndex}) => {
                const d=document.createElement('div');
                d.className='ordering-item';
                d.dataset.originalIndex=originalIndex; // Store original index if needed

                const s=document.createElement('select');
                s.className='ordering-select';
                s.dataset.itemIndex=originalIndex; // Link select to original item index

                const defaultOpt=document.createElement('option');
                defaultOpt.value="";
                defaultOpt.textContent="-";
                defaultOpt.selected=true;
                defaultOpt.disabled=true;
                s.appendChild(defaultOpt);

                for(let j=1;j<=numItems;j++){
                    const opt=document.createElement('option');
                    opt.value=j;
                    opt.textContent=j;
                    s.appendChild(opt);
                }
                s.addEventListener('change', checkCompletion); // Check on change

                const sp=document.createElement('span');
                sp.className='ordering-text';
                sp.textContent=itemText;

                d.append(s,sp); // Append select and text
                oC.appendChild(d);
            });
            c.appendChild(oC);
            // updateUiLanguage(getCurrentLang()); // Called by displayQuestion
        }

        // --- Interaction Handlers ---
        function handleMatchingClick(event) {
            // Get the actual item clicked, whether via mouse or keyboard event target
            const clickedItem = event.target.closest('.matching-item');
            if (!clickedItem || clickedItem.disabled) return; // Ignore if not an item or disabled

            const isRTL = mainContainerElement.classList.contains('rtl-layout');
            const isPrompt = clickedItem.classList.contains('prompt-item');
            const isMatch = clickedItem.classList.contains('match-item');
            const isAlreadyMatched = clickedItem.classList.contains('matched');
            const clickedIndex = clickedItem.dataset.index; // Always the original index

            // --- Case 1: Clicking an already matched item (prompt or match) to DESELECT ---
            if (isAlreadyMatched) {
                let promptIndexToClear = -1;
                let matchIndexToClear = -1;

                // Find the pair to clear based on which item was clicked
                if (isPrompt) { // Clicked a matched prompt item (visually right in RTL)
                    promptIndexToClear = clickedIndex;
                    matchIndexToClear = quizState.matchingState.userPairs[promptIndexToClear];
                } else { // Clicked a matched match item (visually left in RTL)
                    matchIndexToClear = clickedIndex;
                    // Find the prompt index associated with this match index
                    promptIndexToClear = Object.keys(quizState.matchingState.userPairs).find(
                        pIdx => quizState.matchingState.userPairs[pIdx] == matchIndexToClear
                    );
                }

                // If a valid pair was identified
                if (promptIndexToClear != -1 && matchIndexToClear !== undefined && promptIndexToClear !== undefined) {
                    const promptElement = document.getElementById(`prompt-${promptIndexToClear}`);
                    const matchElement = document.getElementById(`match-${matchIndexToClear}`);

                    // Remove visual cues
                    if (promptElement) promptElement.classList.remove('matched', 'selected');
                    if (matchElement) matchElement.classList.remove('matched', 'selected');

                    // Remove the pairing data and the arrow
                    delete quizState.matchingState.userPairs[promptIndexToClear];
                    removeArrow(promptIndexToClear);

                    // Clear any residual selection state
                    quizState.matchingState.selectedPromptElement = null;
                    quizState.matchingState.selectedMatchElement = null;

                    // Disable submit button as the set is no longer complete
                    const submitBtn = document.getElementById('submit-btn');
                    if (submitBtn) submitBtn.disabled = true;
                }
                return; // Done handling deselect
            }


            // --- Case 2: Selecting items to form a pair ---
            if (isRTL) {
                 // --- RTL FLOW --- User interacts with Match (visually left) then Prompt (visually right)
                if (isMatch) { // Clicked a MATCH item (visually left)
                    if (clickedItem === quizState.matchingState.selectedMatchElement) {
                        // Clicking the selected match again: Deselect it
                        clickedItem.classList.remove('selected');
                        quizState.matchingState.selectedMatchElement = null;
                    } else {
                        // Clicking a new match: Deselect old (if any), select new
                        if (quizState.matchingState.selectedMatchElement) {
                            quizState.matchingState.selectedMatchElement.classList.remove('selected');
                        }
                        clickedItem.classList.add('selected');
                        quizState.matchingState.selectedMatchElement = clickedItem;
                        // In RTL, clear prompt selection when a match is selected
                        if(quizState.matchingState.selectedPromptElement) {
                             quizState.matchingState.selectedPromptElement.classList.remove('selected');
                             quizState.matchingState.selectedPromptElement = null;
                        }
                    }
                } else if (isPrompt && quizState.matchingState.selectedMatchElement) {
                    // Clicked a PROMPT item (visually right) WHILE a MATCH item (visually left) is selected: Create pair
                    const matchIndex = quizState.matchingState.selectedMatchElement.dataset.index;
                    const promptIndex = clickedIndex;

                    // Store the user's pair (Prompt Index -> Match Index)
                    quizState.matchingState.userPairs[promptIndex] = parseInt(matchIndex, 10);

                    // Update visuals for the paired items
                    quizState.matchingState.selectedMatchElement.classList.remove('selected');
                    quizState.matchingState.selectedMatchElement.classList.add('matched');
                    clickedItem.classList.add('matched'); // Mark prompt as matched too

                    // Draw arrow: Always pass (Prompt Element, Match Element, Prompt Index)
                    drawArrow(clickedItem, quizState.matchingState.selectedMatchElement, promptIndex);

                    // Clear selection state
                    quizState.matchingState.selectedMatchElement = null;
                    // quizState.matchingState.selectedPromptElement remains null (was cleared before or wasn't set)

                    // Check if all items are matched to enable submit
                    const totalPrompts = document.querySelectorAll('.prompt-item').length;
                    const matchedCount = Object.keys(quizState.matchingState.userPairs).length;
                    const submitBtn = document.getElementById('submit-btn');
                    if (submitBtn && totalPrompts > 0 && totalPrompts === matchedCount) {
                        submitBtn.disabled = false;
                    }
                }
                // Else: Clicking prompt with no match selected, or clicking already matched -> Handled by Case 1 or does nothing

            } else {
                // --- LTR FLOW --- User interacts with Prompt (left) then Match (right)
                 if (isPrompt) { // Clicked a PROMPT item (left)
                    if (clickedItem === quizState.matchingState.selectedPromptElement) {
                        // Clicking the selected prompt again: Deselect it
                        clickedItem.classList.remove('selected');
                        quizState.matchingState.selectedPromptElement = null;
                    } else {
                        // Clicking a new prompt: Deselect old (if any), select new
                        if (quizState.matchingState.selectedPromptElement) {
                            quizState.matchingState.selectedPromptElement.classList.remove('selected');
                        }
                        clickedItem.classList.add('selected');
                        quizState.matchingState.selectedPromptElement = clickedItem;
                        // In LTR, clear match selection when a prompt is selected
                        if(quizState.matchingState.selectedMatchElement) {
                             quizState.matchingState.selectedMatchElement.classList.remove('selected');
                             quizState.matchingState.selectedMatchElement = null;
                        }
                    }
                } else if (isMatch && quizState.matchingState.selectedPromptElement) {
                    // Clicked a MATCH item (right) WHILE a PROMPT item (left) is selected: Create pair
                    const promptIndex = quizState.matchingState.selectedPromptElement.dataset.index;
                    const matchIndex = clickedIndex;

                    // Store the user's pair
                    quizState.matchingState.userPairs[promptIndex] = parseInt(matchIndex, 10);

                    // Update visuals
                    quizState.matchingState.selectedPromptElement.classList.remove('selected');
                    quizState.matchingState.selectedPromptElement.classList.add('matched');
                    clickedItem.classList.add('matched'); // Mark match as matched

                    // Draw arrow: Always pass (Prompt Element, Match Element, Prompt Index)
                    drawArrow(quizState.matchingState.selectedPromptElement, clickedItem, promptIndex);

                    // Clear selection state
                    quizState.matchingState.selectedPromptElement = null;
                    // quizState.matchingState.selectedMatchElement remains null

                    // Check completion
                    const totalPrompts = document.querySelectorAll('.prompt-item').length;
                    const matchedCount = Object.keys(quizState.matchingState.userPairs).length;
                    const submitBtn = document.getElementById('submit-btn');
                    if (submitBtn && totalPrompts > 0 && totalPrompts === matchedCount) {
                        submitBtn.disabled = false;
                    }
                }
                 // Else: Clicking match with no prompt selected, or clicking already matched -> Handled by Case 1 or does nothing
            }
        }


        // --- Arrow Drawing (Corrected for RTL X and Y Coordinates) ---
        function drawArrow(pE, mE, pI) {
            // pE = Prompt Element (Items column in LTR, Right column in RTL)
            // mE = Match Element (Matches column in LTR, Left column in RTL)
            // pI = Prompt Index (used for arrow ID)

            const outerDiv = document.getElementById(`matching-outer-${quizState.currentQuestionIndex}`);

            // Ensure SVG exists; Locate it reliably if needed.
             if (!matchingSvgElement) {
                 const svgContainer = outerDiv?.querySelector('svg#matching-arrow-svg');
                 if (svgContainer) {
                     matchingSvgElement = svgContainer;
                 } else {
                    console.error("drawArrow: SVG element '#matching-arrow-svg' not found within outerDiv:", outerDiv?.id);
                    return; // Cannot draw without SVG
                 }
             }

            // Ensure all required elements are valid before proceeding
            if (!pE || !mE || !outerDiv) {
                 console.warn("drawArrow: Missing required elements (prompt, match, or outer div). Prompt:", pE?.id, "Match:", mE?.id, "Index:", pI);
                 return;
            }

            // Get bounding rectangles *inside* the function for fresh values
            const svgRect = matchingSvgElement.getBoundingClientRect();
            const pR = pE.getBoundingClientRect(); // Prompt Element Rect
            const mR = mE.getBoundingClientRect(); // Match Element Rect
            const isRTL = mainContainerElement.classList.contains('rtl-layout');

            let startX, startY, endX, endY;

            // Calculate Midpoints relative to SVG Top (Common calculation)
            const promptMidY = pR.top + pR.height / 2 - svgRect.top;
            const matchMidY  = mR.top + mR.height / 2 - svgRect.top;

            // --- Calculate X and Y based on Layout Direction ---
            if (isRTL) {
                // RTL VISUAL: Match(Left) --> Prompt(Right)
                // Start Point: LEFT edge of Match element (mE)
                // End Point:   RIGHT edge of Prompt element (pE)

                startX = mR.left - svgRect.left;   // X: Left edge of the Match element relative to SVG left
                startY = matchMidY;                // Y: Vertical center of the Match element (VISUAL START)

                endX   = pR.right - svgRect.left;  // X: Right edge of the Prompt element relative to SVG left
                endY   = promptMidY;               // Y: Vertical center of the Prompt element (VISUAL END)

            } else {
                // LTR VISUAL: Prompt(Left) --> Match(Right)
                // Start Point: RIGHT edge of Prompt element (pE)
                // End Point:   LEFT edge of Match element (mE)

                startX = pR.right - svgRect.left; // X: Right edge of the Prompt element relative to SVG left
                startY = promptMidY;              // Y: Vertical center of the Prompt element (VISUAL START)

                endX   = mR.left - svgRect.left;  // X: Left edge of the Match element relative to SVG left
                endY   = matchMidY;               // Y: Vertical center of the Match element (VISUAL END)
            }

            // Find or create the line element
            let line = matchingSvgElement.querySelector(`#arrow-${pI}`);
            if (!line) {
                line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.id = `arrow-${pI}`;
                line.style.opacity = '0'; // Start invisible for transition
                line.style.transition = 'stroke 0.3s ease, opacity 0.3s ease';
                matchingSvgElement.appendChild(line);
            }

            // Validate coordinates before applying
             if (isNaN(startX) || isNaN(startY) || isNaN(endX) || isNaN(endY) ||
                 !isFinite(startX) || !isFinite(startY) || !isFinite(endX) || !isFinite(endY)) {
                 console.error("drawArrow: Invalid coordinates calculated.", { startX, startY, endX, endY, pI, isRTL });
                 line.style.opacity = '0'; // Hide potentially broken line
                 return; // Stop execution for this arrow if coords are bad
             }

            // Apply calculated coordinates and styles
            line.setAttribute('x1', startX);
            line.setAttribute('y1', startY);
            line.setAttribute('x2', endX);
            line.setAttribute('y2', endY);
            line.setAttribute('stroke', 'var(--accent-color)');
            line.setAttribute('stroke-width', '2');
            line.setAttribute('marker-end', 'url(#arrowhead)');

            // Use rAF for smoother visual update
            requestAnimationFrame(() => {
                 line.style.opacity = '1'; // Make the line visible
            });
        }

        function removeArrow(pI){if(!matchingSvgElement)return;const l=matchingSvgElement.querySelector(`#arrow-${pI}`);if(l){l.style.opacity='0';setTimeout(()=>l.remove(),300);}} // Transition fade out
        function updateAllArrowPositions(){
             // Ensure we are in a matching question state
             if(!matchingSvgElement || !quizState || !quizState.questions[quizState.currentQuestionIndex] || quizState.questions[quizState.currentQuestionIndex].type !== 'matching') {
                 return;
             }
             const userPairs = quizState.matchingState.userPairs;
             // Redraw arrows for all existing pairs
             for (const promptIndex in userPairs) {
                 if (userPairs.hasOwnProperty(promptIndex)) {
                     const matchIndex = userPairs[promptIndex];
                     const promptElement = document.getElementById(`prompt-${promptIndex}`);
                     const matchElement = document.getElementById(`match-${matchIndex}`);
                     if (promptElement && matchElement) {
                         drawArrow(promptElement, matchElement, promptIndex);
                     } else {
                         // If an element is missing (shouldn't normally happen), remove the arrow
                         removeArrow(promptIndex);
                     }
                 }
             }
        }
        function setupArrowObserver(){
            const targetNode = document.getElementById('matching-cols');
            if (!targetNode || !matchingSvgElement) {
                console.warn("Observer setup failed: Target or SVG missing.");
                return;
            }
            if (matchingArrowObserver) { matchingArrowObserver.disconnect(); } // Disconnect previous if exists

            const config = { attributes: true, childList: true, subtree: true, characterData: true };
            // Debounced callback to prevent excessive redraws during rapid changes
            const callback = debounce(updateAllArrowPositions, 50);

            matchingArrowObserver = new MutationObserver(callback);
            matchingArrowObserver.observe(targetNode, config);

            // Also observe quiz container for broader layout shifts (like resizing)
            const quizContainerTarget = document.getElementById('quiz-container');
            if(quizContainerTarget) {
                // Observe attributes change which might indicate style changes affecting layout
                matchingArrowObserver.observe(quizContainerTarget, { attributes: true, subtree: false });
            }

            // Initial draw/update after a short delay to allow rendering
            setTimeout(updateAllArrowPositions, 100);
        }


        // --- Answer Checking ---
        function checkAnswer(){
            if(!feedbackContainerElement||!quizButtonsContainerElement)return;
            // Disconnect observer during feedback display to prevent updates based on feedback styling
            if(matchingArrowObserver){matchingArrowObserver.disconnect(); matchingArrowObserver = null;}

            const cQ=quizState.questions[quizState.currentQuestionIndex];
            let result = {isCorrect:false, feedback:'', userResponse:null, scoreIncrement:0};

            try{
                switch(cQ.type){
                    case "matching": result = checkMatching(cQ); break;
                    case "ordering": result = checkOrdering(cQ); break;
                    case "multiple_choice": default: result = checkMultipleChoice(cQ); break;
                }
            } catch(e){
                console.error("Error checking answer:", e);
                const strings = getStrings();
                result = {isCorrect:false, feedback:`<div class="incorrect-feedback">${strings.defaultErrorMessage || 'Error checking answer.'}</div>`, userResponse:null, scoreIncrement:0}; // i18n
            }

            quizState.selectedAnswers[quizState.currentQuestionIndex]=result.userResponse;
            if(result.scoreIncrement>0) quizState.correctAnswers+=result.scoreIncrement;

            feedbackContainerElement.innerHTML=result.feedback;
            feedbackContainerElement.classList.remove('hidden');
            disableInputs();

            // Toggle buttons
            const submitBtn=quizButtonsContainerElement.querySelector('#submit-btn');
            const nextBtn=quizButtonsContainerElement.querySelector('#next-btn');
            if(submitBtn) submitBtn.classList.add('hidden');
            if(nextBtn) {
                // Update Next button text if it's the last question
                const strings = getStrings();
                const nextBtnTextKey = (quizState.currentQuestionIndex === quizState.totalQuestions - 1 && quizState.totalQuestions > 0) ? 'viewResults' : 'next';
                const textSpan = nextBtn.querySelector('.btn-text');
                if (textSpan) textSpan.textContent = strings[nextBtnTextKey] || nextBtnTextKey;

                nextBtn.classList.remove('hidden');
            }
        }
        function checkMultipleChoice(q){const sR=document.querySelector('input[name="question-option"]:checked');if(!sR)return{isCorrect:false,feedback:'<div class="incorrect-feedback">Select answer.</div>',userResponse:null,scoreIncrement:0};const sI=parseInt(sR.value,10),cAT=q.answer,sAT=q.options?.[sI],iC=sAT===cAT;document.querySelectorAll('.option-label').forEach((l,i)=>{const ip=l.querySelector('input');if(q.options?.[i]===cAT)l.classList.add('correct-option');if(ip&&ip.checked&&!iC)l.classList.add('incorrect-option');});const fH=iC?'<div class="correct-feedback">Correct! ✓</div>':`<div class="incorrect-feedback">Incorrect. <span>Correct: ${cAT||'N/A'}</span></div>`;return{isCorrect:iC,feedback:fH,userResponse:sI,scoreIncrement:iC?1:0};} // TODO: i18n Feedback
        function checkMatching(q){const uP=quizState.matchingState.userPairs,cP=q.answer||{},tCP=Object.keys(cP).length;let cMC=0;if(tCP===0)return{isCorrect:true,feedback:'<div class="correct-feedback">No match needed.</div>',userResponse:uP,scoreIncrement:0};for(const pI in cP)if(uP.hasOwnProperty(pI)&&uP[pI]===cP[pI])cMC++;const iFC=cMC===tCP&&Object.keys(uP).length===tCP,iPC=cMC>0&&!iFC;let fH="";if(iFC)fH=`<div class="correct-feedback">Correct! ✓ All matched.</div>`;else if(iPC)fH=`<div class="partial-feedback">Partial. ${cMC}/${tCP}.</div>`;else fH=`<div class="incorrect-feedback">Incorrect. 0/${tCP}.</div>`;for(const pI in uP){const uMI=uP[pI],cMI=cP[pI],l=matchingSvgElement?.querySelector(`#arrow-${pI}`),pE=document.getElementById(`prompt-${pI}`),uME=document.getElementById(`match-${uMI}`);if(!l || !pE || !uME) continue; /* Safety check */ if(uMI===cMI){l.style.stroke='var(--correct-border)';l.querySelector('polygon')?.setAttribute('fill', 'var(--correct-border)');pE.style.borderColor='var(--correct-border)';uME.style.borderColor='var(--correct-border)';}else{l.style.stroke='var(--incorrect-border)';l.querySelector('polygon')?.setAttribute('fill', 'var(--incorrect-border)');pE.style.borderColor='var(--incorrect-border)';uME.style.borderColor='var(--incorrect-border)';}}return{isCorrect:iFC,feedback:fH,userResponse:uP,scoreIncrement:iFC?1:0};} // TODO: i18n Feedback
        function checkOrdering(q){const oI=q.items||[],cAO=q.answer||[],nI=oI.length;if(nI===0||!Array.isArray(cAO)||nI!==cAO.length)return console.error("Invalid ord data:",q),{isCorrect:false,feedback:'<div class="incorrect-feedback">Err: Invalid setup.</div>',userResponse:null,scoreIncrement:0};const uOM={},sP=new Set();let aS=true,hD=false;const sE=document.querySelectorAll("#ordering-list .ordering-select");if(sE.length!==nI)return console.error("Ord Err: Select mismatch."),{isCorrect:false,feedback:'<div class="incorrect-feedback">Err processing sel.</div>',userResponse:null,scoreIncrement:0};sE.forEach(s=>{const iI=parseInt(s.dataset.itemIndex,10),sV=s.value;if(sV===""){aS=false;}else{const p=parseInt(sV,10);if(isNaN(p)||p<1||p>nI){aS=false;return;}uOM[iI]=p;if(sP.has(p))hD=true;sP.add(p);}});if(!aS)return{isCorrect:false,feedback:'<div class="incorrect-feedback">Select order all.</div>',userResponse:uOM,scoreIncrement:0};if(hD||sP.size!==nI){const nT=nI>1?`nums 1-${nI}`:'num 1';return{isCorrect:false,feedback:`<div class="incorrect-feedback">Use each order ${nT} once.</div>`,userResponse:uOM,scoreIncrement:0};}const uOI=new Array(nI).fill(null);let cOk=true;for(const iIS in uOM){if(uOM.hasOwnProperty(iIS)){const iI=parseInt(iIS,10),iT=oI[iI],uP=uOM[iI]-1;if(iT===undefined||uP<0||uP>=nI||uOI[uP]!==null){cOk=false;break;}uOI[uP]=iT;}}if(!cOk||uOI.some(i=>i===null))return console.error("Ord Err: Construct fail.",uOM,uOI),{isCorrect:false,feedback:'<div class="incorrect-feedback">Err processing seq.</div>',userResponse:uOI,scoreIncrement:0};const iC=JSON.stringify(uOI)===JSON.stringify(cAO);const fH=iC?'<div class="correct-feedback">Correct! ✓</div>':`<div class="incorrect-feedback">Incorrect. <span>Correct: ${cAO.join(" → ")}</span></div>`;sE.forEach(s=>{const iI=parseInt(s.dataset.itemIndex,10),iT=oI[iI],uSP=uOM[iI],cP=cAO.indexOf(iT)+1;if(uSP===cP){s.style.borderColor="var(--correct-border)";s.style.backgroundColor="var(--correct-bg)";}else{s.style.borderColor="var(--incorrect-border)";s.style.backgroundColor="var(--incorrect-bg)";}s.style.borderWidth="2px";});return{isCorrect:iC,feedback:fH,userResponse:uOI,scoreIncrement:iC?1:0};} // TODO: i18n Feedback
        function disableInputs(){document.querySelectorAll('input[name="question-option"],.ordering-select').forEach(i=>i.disabled=true);document.querySelectorAll('.option-label').forEach(l=>l.style.cursor='default');document.querySelectorAll('.matching-item').forEach(i=>{i.style.pointerEvents='none';i.style.cursor='default';i.tabIndex = -1; /* Disable focus */ });}

        // --- Navigation and Results ---
        function nextQuestion(){quizState.currentQuestionIndex++;if(quizState.currentQuestionIndex<quizState.totalQuestions)displayQuestion();else{quizState.endTime=new Date();displayResults();}}

        function displayResults(){
            if(!quizContainerElement||!feedbackContainerElement||!quizButtonsContainerElement||!quizTitleElement)return;
            quizContainerElement.innerHTML='';feedbackContainerElement.classList.add('hidden');quizButtonsContainerElement.innerHTML='';

            const strings = getStrings();
            quizTitleElement.textContent = strings.viewResults || 'Quiz Results'; // Set title

            const tT=quizState.endTime&&quizState.startTime?Math.round((quizState.endTime-quizState.startTime)/1000):0;
            const tS=formatTime(tT);
            const score = quizState.totalQuestions>0?(quizState.correctAnswers/quizState.totalQuestions)*100:0;
            const scoreRounded=score.toFixed(0);

            // Save stats if questions existed
            if(quizState.totalQuestions>0)saveLessonStats(quizState.subject,quizState.semester,quizState.unit,quizState.lesson,quizState.correctAnswers,quizState.totalQuestions,tT);

            // Determine result message using i18n strings
            let resultMessageKey = 'quizResultPractice'; // Default
            if (quizState.totalQuestions === 0) resultMessageKey = 'quizResultNoQuestions';
            else if (score >= 90) resultMessageKey = 'quizResultExcellent';
            else if (score >= 70) resultMessageKey = 'quizResultGreat';
            else if (score >= 50) resultMessageKey = 'quizResultGood';
            const resultMessage = strings[resultMessageKey] || '';

            const rD=document.createElement('div');rD.className='results-container';
            // Use resultMessage for the header
            rD.innerHTML=` <h2 class="results-header">${resultMessage}</h2> <div class="results-score"><div class="score-circle"><span class="score-number">${scoreRounded}</span><span class="score-percent-sign">%</span></div></div> <div class="results-details"> <p data-detail-key="subject"><span class="detail-icon">📚</span><strong>${strings.resultsSubjectLabel || 'Subject:'}</strong> <span class="detail-value">${quizState.subject||'N/A'}</span></p> <p data-detail-key="semester"><span class="detail-icon">🗓️</span><strong>${strings.resultsSemesterLabel || 'Semester:'}</strong> <span class="detail-value">${quizState.semester||'N/A'}</span></p> <p data-detail-key="unit"><span class="detail-icon">🔖</span><strong>${strings.resultsUnitLabel || 'Unit:'}</strong> <span class="detail-value">${quizState.unit||'N/A'}</span></p> <p data-detail-key="lesson"><span class="detail-icon">📖</span><strong>${strings.resultsLessonLabel || 'Lesson:'}</strong> <span class="detail-value">${quizState.lesson||'N/A'}</span></p> <p data-detail-key="correct"><span class="detail-icon">✅</span><strong>${strings.resultsCorrectLabel || 'Correct:'}</strong> <span class="detail-value">${quizState.correctAnswers}/${quizState.totalQuestions}</span></p> <p data-detail-key="time"><span class="detail-icon">⏱️</span><strong>${strings.resultsTimeLabel || 'Time:'}</strong> <span class="detail-value">${tS}</span></p> </div>`;
            quizContainerElement.appendChild(rD);

            // Actions Container
            const aD=document.createElement('div');aD.className='results-actions quiz-buttons'; // Re-use class for consistent styling

            // Redo Button
            const rB=document.createElement('button');rB.className='btn redo-btn'; rB.id='redo-btn'; rB.innerHTML=`🔄 <span class="btn-text">${strings.redoQuiz || 'Redo Quiz'}</span>`; rB.onclick=()=>{startQuiz(quizState.subject,quizState.semester,quizState.unit,quizState.lesson,quizState.originalQuestions);};
            aD.appendChild(rB);

            // Review Button (only if there were questions)
            if(quizState.totalQuestions>0){const revB=document.createElement('button');revB.id='review-btn';revB.className='btn review-btn';revB.innerHTML=`🧐 <span class="btn-text">${strings.reviewAnswers || 'Review Answers'}</span>`;revB.onclick=reviewAnswers;aD.appendChild(revB);}

            // Back to Topics Button
            const bTB=document.createElement('button');bTB.className='btn back-to-topics-btn'; bTB.id='back-to-topics-btn-results'; bTB.innerHTML=`<span>⬅️</span> <span class="btn-text">${strings.backToTopics || 'Back to Topics'}</span>`;bTB.onclick=showTopicList;
            aD.appendChild(bTB); // Add to actions container

            quizButtonsContainerElement.appendChild(aD); // Add actions container to main button area
            // updateUiLanguage(getCurrentLang()); // No need, labels set directly
        }


        // --- Answer Review ---
        function reviewAnswers(){
            if(!quizContainerElement||!feedbackContainerElement||!quizButtonsContainerElement||!quizTitleElement)return;
            quizContainerElement.innerHTML='';feedbackContainerElement.classList.add('hidden');quizButtonsContainerElement.innerHTML='';

            const strings = getStrings();
            quizTitleElement.textContent = `${strings.reviewTitlePrefix || 'Review'}: ${quizState.lesson || ''}`;

            const rD=document.createElement('div');rD.className='review-container';
            quizState.questions.forEach((q,i)=>{
                const questionDiv=document.createElement('div');
                const userAnswer=quizState.selectedAnswers[i];
                let {correctnessClass: statusClass, statusText} = calculateReviewStatus(q, userAnswer); // Get status class and text

                questionDiv.className=`question-review ${statusClass}`; // Use class from calculation
                const questionTypeDisplay=(q.type||'multiple_choice').replace('_',' ');

                // Build header with status
                questionDiv.innerHTML=`<div class="review-question-header"><span class="review-question-number">Q ${i+1} (${questionTypeDisplay})</span><span class="review-status">${statusText}</span></div><p class="review-question-text">${q.question||'?'}</p><div class="review-answer-content" id="review-answer-content-${i}"></div>`;
                rD.appendChild(questionDiv);

                // Populate answer details
                const contentArea=questionDiv.querySelector(`#review-answer-content-${i}`);
                if(contentArea){
                    try{
                        switch(q.type){
                            case"matching": reviewMatchingReview(q,userAnswer,contentArea);break;
                            case"ordering": reviewOrderingReview(q,userAnswer,contentArea);break;
                            case"multiple_choice": default: reviewMultipleChoiceReview(q,userAnswer,contentArea);break;
                        }
                    } catch(e) {
                        console.error("Error rendering review answer:", e);
                        contentArea.innerHTML=`<p style="color:red">Error displaying review.</p>`; // i18n needed
                    }
                } else {
                    console.warn(`Could not find content area for review question ${i}`);
                }
            });
            quizContainerElement.appendChild(rD);

            // Actions Container
            const aD=document.createElement('div');aD.className='review-actions quiz-buttons';

            // Back to Results Button
            const bRB=document.createElement('button');bRB.className='btn back-btn'; bRB.id = 'back-btn'; bRB.innerHTML=`<span>←</span> <span class="btn-text">${strings.backToResults || 'Back to Results'}</span>`; bRB.onclick=displayResults;
            aD.appendChild(bRB);

            // Back to Topics Button
            const bTB=document.createElement('button');bTB.className='btn back-to-topics-btn'; bTB.id = 'back-to-topics-btn-review'; bTB.innerHTML=`<span>⬅️</span> <span class="btn-text">${strings.backToTopics || 'Back to Topics'}</span>`; bTB.onclick=showTopicList;
            aD.appendChild(bTB);

            quizButtonsContainerElement.appendChild(aD);
            quizContainerElement.scrollIntoView({behavior:'smooth',block:'start'});
            // updateUiLanguage(getCurrentLang()); // No need, set directly
        }

        function calculateReviewStatus(q,uA){
            let correctnessClass='incorrect';
            let statusText = getStrings().reviewStatusIncorrect || '✗ Incorrect'; // Default to incorrect
            let isCorrect = false;
            let isPartial = false;
            const strings = getStrings(); // Get strings once

            try{
                switch(q.type){
                    case"matching":
                        const correctPairs = q.answer || {};
                        const totalCorrectPairs = Object.keys(correctPairs).length;
                        let correctlyMatchedCount = 0;
                        if(totalCorrectPairs > 0 && uA && typeof uA === 'object') {
                            for(const pI in correctPairs) {
                                if(uA.hasOwnProperty(pI) && uA[pI] === correctPairs[pI]) {
                                    correctlyMatchedCount++;
                                }
                            }
                        }
                        isCorrect = totalCorrectPairs > 0 && correctlyMatchedCount === totalCorrectPairs && Object.keys(uA || {}).length === totalCorrectPairs;
                        isPartial = totalCorrectPairs > 0 && correctlyMatchedCount > 0 && !isCorrect;

                        if (isCorrect) {
                            correctnessClass = "correct";
                            statusText = strings.reviewStatusCorrect || "✓ Correct";
                        } else if (isPartial) {
                            correctnessClass = "partial";
                            statusText = (strings.reviewStatusPartial || "~ Partial ({correct}/{total})")
                                         .replace('{correct}', correctlyMatchedCount)
                                         .replace('{total}', totalCorrectPairs);
                        } else if (uA === null || Object.keys(uA || {}).length === 0) {
                             statusText = strings.reviewStatusUnanswered || 'Unanswered';
                        }
                        break;

                    case"ordering":
                        isCorrect = uA && Array.isArray(uA) && q.answer && Array.isArray(q.answer) && JSON.stringify(uA) === JSON.stringify(q.answer);
                        if (uA === null || !Array.isArray(uA)) { // Check if unanswered
                            statusText = strings.reviewStatusUnanswered || 'Unanswered';
                            correctnessClass = 'incorrect'; // Keep class as incorrect
                        } else if (isCorrect) {
                            correctnessClass = "correct";
                            statusText = strings.reviewStatusCorrect || "✓ Correct";
                        }
                        // No partial state for ordering in this logic
                        break;

                    case"multiple_choice": default:
                        isCorrect = uA !== null && q.options && q.answer && q.options[uA] === q.answer;
                        if (uA === null) { // Check if unanswered
                            statusText = strings.reviewStatusUnanswered || 'Unanswered';
                            correctnessClass = 'incorrect';
                        } else if (isCorrect) {
                            correctnessClass = "correct";
                            statusText = strings.reviewStatusCorrect || "✓ Correct";
                        }
                        break;
                }
            } catch(e) {
                console.error("Error calculating review status:", e);
                correctnessClass = 'incorrect';
                statusText = 'Error'; // Keep simple error text
            }
            return { correctnessClass, statusText };
        }

        function reviewMultipleChoiceReview(q,uAI,c){
            const strings = getStrings();
            const d=document.createElement("div");d.className="review-mc-answer";
            const userSelectedText=(uAI!==null&&q.options?.[uAI]!==undefined)?q.options[uAI]:(strings.reviewStatusUnanswered || "No answer"); // Use unanswered string
            const isCorrect=(uAI!==null&&userSelectedText===q.answer);
            let userAnswerHTML=`<span class="user-answer-text`;
            if(uAI===null)userAnswerHTML+=`">`; // Neutral style for unanswered
            else if(isCorrect)userAnswerHTML+=` correct">`;
            else userAnswerHTML+=` incorrect">`;
            userAnswerHTML+=`${userSelectedText}</span>`;
            // Use translated labels
            d.innerHTML=`<p><strong>${strings.resultsYourAnswerLabel || 'Your Answer:'}</strong> ${userAnswerHTML}</p>`;
            if(!isCorrect && uAI !== null) { // Only show correct if user answered incorrectly
                d.innerHTML+=`<p><strong>${strings.resultsCorrectAnswerLabel || 'Correct Answer:'}</strong> <span class="correct-answer-text">${q.answer||"N/A"}</span></p>`;
            } else if (!isCorrect && uAI === null) { // Show correct if unanswered
                 d.innerHTML+=`<p><strong>${strings.resultsCorrectAnswerLabel || 'Correct Answer:'}</strong> <span class="correct-answer-text">${q.answer||"N/A"}</span></p>`;
            }
            c.appendChild(d);
        }
        function reviewMatchingReview(q,uP,c){
            const strings = getStrings();
            const d=document.createElement("div");d.className="review-matching-answer";
            d.innerHTML=`<p><strong>${strings.matchingMatchesHeader || 'Matches'}:</strong></p>`; // Use translated header
            const grid=document.createElement("div");grid.className="review-matching-grid";
            const promptsCol=document.createElement("div"), matchesCol=document.createElement("div");
            promptsCol.className="review-matching-column";matchesCol.className="review-matching-column";
            const correctPairs=q.answer||{},promptsList=q.prompts||[],matchesList=q.matches||[];

            promptsList.forEach((promptText,promptIndex)=>{
                const userMatchIndex=uP?uP[promptIndex]:null; // User's matched index for this prompt
                const correctMatchIndex=correctPairs[promptIndex]; // Correct matched index for this prompt
                const isPairCorrect=(userMatchIndex!==null&&userMatchIndex===correctMatchIndex);

                const promptDiv=document.createElement("div");promptDiv.textContent=`${promptIndex+1}. ${promptText}`;
                const matchDiv=document.createElement("div");

                // Get text for user's match and correct match
                const userMatchText = (userMatchIndex!==null&&matchesList[userMatchIndex]!==undefined)?matchesList[userMatchIndex]:`(${strings.reviewStatusUnanswered || 'Unanswered'})`; // Use unanswered string
                const correctMatchText = (correctMatchIndex!==undefined&&matchesList[correctMatchIndex]!==undefined)?matchesList[correctMatchIndex]:"(N/A)"; // N/A if correct answer is missing

                if (isPairCorrect) {
                    promptDiv.className="review-matched-pair-correct";
                    matchDiv.textContent=correctMatchText; // Show only the correct match
                    matchDiv.className="review-matched-pair-correct";
                } else {
                    promptDiv.className="review-matched-pair-incorrect";
                    // Show user's incorrect match (struck through) and the correct one
                    matchDiv.innerHTML=`<span style="text-decoration:line-through;">${userMatchText}</span> <span style="font-weight:500;">(${correctMatchText})</span>`;
                    matchDiv.className="review-matched-pair-incorrect";
                }
                promptsCol.appendChild(promptDiv);
                matchesCol.appendChild(matchDiv);
            });
            grid.append(promptsCol,matchesCol);
            d.appendChild(grid);
            c.appendChild(d);
        }
        function reviewOrderingReview(q,uOI,c){
            const strings = getStrings();
            const d=document.createElement("div");d.className="review-ordering-answer";
            const correctOrder=q.answer||[];
            const isFullyCorrect=uOI&&JSON.stringify(uOI)===JSON.stringify(correctOrder);
            d.innerHTML=`<p><strong>${strings.orderingInstruction ? strings.orderingInstruction.split(':')[0] : 'Ordering'}:</strong></p>`; // Basic label

            const list=document.createElement("div");list.className="review-ordering-list";

            correctOrder.forEach((correctItemText,correctIndex)=>{
                const itemDiv=document.createElement("div");
                itemDiv.className="review-ordering-list-item";

                // Find where the user placed this item
                const userIndex = uOI ? uOI.indexOf(correctItemText) : -1;
                const userPosition = (userIndex !== -1) ? userIndex + 1 : null; // User's selected position (1-based)
                const correctPosition = correctIndex + 1; // Correct position (1-based)

                let numberSpanHTML='';
                if (userPosition === correctPosition) { // Correctly placed
                    numberSpanHTML=`<span class="review-order-number review-order-correct">${correctPosition}.</span>`;
                    itemDiv.style.backgroundColor='var(--correct-bg)';
                } else if (userPosition !== null) { // Placed, but incorrectly
                    numberSpanHTML=`<span class="review-order-number review-order-incorrect">${userPosition}.</span> <span class="review-order-number review-order-correct">(${correctPosition}.)</span>`;
                    itemDiv.style.backgroundColor='var(--incorrect-bg)';
                } else { // Not placed by user (likely unanswered or error)
                    numberSpanHTML=`<span class="review-order-number review-order-incorrect">(${strings.reviewStatusUnanswered || 'NP'})</span> <span class="review-order-number review-order-correct">(${correctPosition}.)</span>`;
                    itemDiv.style.backgroundColor='var(--partial-bg)'; // Use partial as 'missed'
                }

                itemDiv.innerHTML=`${numberSpanHTML} ${correctItemText}`;
                list.appendChild(itemDiv);
            });
            d.appendChild(list);
            c.appendChild(d);
        }


        // --- Error Display ---
        function showError(subj, unit, lesson, customMessage = '') {
            if(!quizContainerElement||!feedbackContainerElement||!quizButtonsContainerElement||!quizTitleElement)return;
            showQuizView(); // Ensure quiz view is visible

            const strings = getStrings();
            quizTitleElement.textContent = strings.defaultErrorMessage.includes('load') ? strings.defaultErrorMessage : 'Error'; // Generic title

            quizContainerElement.innerHTML=''; // Clear previous content
            feedbackContainerElement.classList.add('hidden');
            quizButtonsContainerElement.innerHTML='';

            // Construct error message
            const defaultMsg = (strings.defaultErrorMessage || "No questions found for \"{lesson}\" in \"{unit}\".")
                                .replace('{lesson}', lesson || 'N/A')
                                .replace('{unit}', unit || 'N/A');
            const displayMsg = customMessage || defaultMsg;

            const errorDiv=document.createElement('div');
            errorDiv.className='error-display';
            errorDiv.innerHTML=`<div class="error-message">${displayMsg}</div>`;

            // Back button
            const backBtn=document.createElement('button');
            backBtn.className='btn back-to-topics-btn'; // Use consistent class
            backBtn.id='back-to-topics-btn-error'; // Specific ID if needed
            backBtn.innerHTML=`<span>⬅️</span> <span class="btn-text">${strings.backToTopics || 'Back to Topics'}</span>`;
            backBtn.onclick=showTopicList;
            errorDiv.appendChild(backBtn);

            quizContainerElement.appendChild(errorDiv);
            // updateUiLanguage(getCurrentLang()); // Buttons set directly
        }

        // --- Get Questions Data ---
        function getQuestions(subj,sem,unitT,lessonT){if(!subj||!sem||!unitT||!lessonT)return console.error("Missing getQ params:",{subj,sem,unitT,lessonT}),[];try{const sD=topicsData[subj]?.[sem];if(!sD?.units)return console.warn(`Units miss: ${subj}->${sem}`),[];const u=sD.units.find(un=>un?.title===unitT);if(!u?.lessons)return console.warn(`Unit/Les miss: "${unitT}" ${subj}->${sem}.`),[];const l=u.lessons.find(ls=>ls?.title===lessonT);if(!l)return console.warn(`Les miss: "${lessonT}".`),[];if(Array.isArray(l.questions)&&l.questions.length>0)return l.questions.map(q=>({...(q.type?{}:{type:'multiple_choice'}),...q}));else return console.log(`No Qs for "${lessonT}".`),[];}catch(e){console.error("Err getQ:",e);return[];}}

        // --- END OF questions.js ---
    </script>

</body>
</html>
